(()=>{window.addEventListener("load",async()=>{let c=document.querySelector("article"),i=document.getElementsByClassName("gallery")[0],w=document.getElementById("top-button"),g=new Set,s=0,E="",d=[],l,p=!1,u=!1,h=5,b=document.createElement("div");w.appendChild(b);let C=0;function $(){b.innerHTML=`Items Loaded: ${C}<br>Loading Status: ${p}/${u}<br>Scroll Height:${c.scrollHeight}/${c.clientHeight}+200`}function H(t){for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}}function I(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),r=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${r})`}try{let e=await(await fetch("media.json")).json();E=e.gallery_name,d=e.items,v(),await M()}catch(t){console.error("Failed to load media.json:",t)}function v(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",i.appendChild(t),i.appendChild(e),l=new Masonry(i,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function M(){for(;c.scrollHeight<=c.clientHeight+200;)await k()}async function k(){if(!(p||u)){p=!0;try{let t=s*h;if(t>=d.length){u=!0;return}let r=d.slice(t,t+h).map(async n=>{if(!n||!n.media||g.has(n.media))return null;g.add(n.media),C++,$();let a=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${E}`,f=n.source.startsWith("http")?n.source:`${a}/${n.source}`,L=n.media.startsWith("http")?n.media:`${a}/${n.media}`;return n.type==="image"?await N(f,L):n.type==="video"?await z(f,L):n.type==="url"?S(f):(console.warn("Unknown type:",n.type),null)}),o=(await Promise.all(r)).filter(Boolean);if(s++,o.length===0){s*h>=media.length&&(u=!0);return}o.forEach(n=>i.appendChild(n)),l&&typeof l.appended=="function"&&l.appended(o),l&&typeof l.layout=="function"&&l.layout(),o.forEach(n=>{let a=n.querySelector("video");a&&m&&m.observe(a)}),s*h>=d.length&&(u=!0)}finally{p=!1}}}function y(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function S(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=I();let r=document.createElement("p");return r.textContent=t,e.appendChild(r),y(e)}async function N(t,e){return new Promise(r=>{let o=document.createElement("img");o.src=e;let n=document.createElement("a");n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.appendChild(o),imagesLoaded(o,()=>{let a=y(n);r(a)}),o.addEventListener("error",()=>{console.warn("Image failed to load:",e),r(null)},{once:!0})})}async function z(t,e){return new Promise(r=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0;let n=document.createElement("source");n.src=e,o.appendChild(n);let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),o.addEventListener("loadeddata",()=>{let f=y(a);r(f)},{once:!0}),o.addEventListener("error",()=>{console.warn("Video failed to load:",e),r(null)},{once:!0})})}let m=null;function B(){m&&m.disconnect(),m=new IntersectionObserver(t=>{t.forEach(e=>{let r=e.target;r.tagName==="VIDEO"&&(e.isIntersecting?r.play().catch(o=>console.warn("Video play error:",o)):r.pause())})},{root:c,rootMargin:"250px 0px 250px 0px"})}c.addEventListener("scroll",async()=>{c.scrollTop>=c.scrollHeight-c.clientHeight-500&&await k()}),w.addEventListener("click",async()=>{H(d),i.innerHTML="",g.clear(),v(),s=0,await M()})});console.log("Mureinoki \xB7 2025");})();
