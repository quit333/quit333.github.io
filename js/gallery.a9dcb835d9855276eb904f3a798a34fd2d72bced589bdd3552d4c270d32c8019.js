(()=>{window.addEventListener("load",async()=>{let i=document.querySelector("article"),l=document.getElementsByClassName("gallery")[0],b=document.getElementById("top-button"),p=new Set,h=5,f="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",u=0,C="",m=[],r,g=0,v,y,z=document.createElement("div"),s=new Set,L=0,A=0,T="",G=!1;b.appendChild(z);function d(){let t=Array.from(s).slice(0,5),e=s.size>5?` (+${s.size-5} more)`:""}let $=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;e.isIntersecting?n.dataset.originalSrc&&n.src===f&&(n.src=n.dataset.originalSrc):(!n.style.width&&n.naturalWidth&&(n.style.width=n.offsetWidth+"px",n.style.height=n.offsetHeight+"px"),n.src&&n.src!==f&&(n.src=f))})},{root:i,rootMargin:"250px 0px 250px 0px"}),B=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;e.isIntersecting?n.play().catch(o=>console.warn("Video play error:",o)):n.pause()})},{root:i,rootMargin:"100px 0px 100px 0px"});try{let e=await(await fetch("media.json")).json();C=e.gallery_name,m=e.items,M(),await k()}catch(t){console.error("Failed to load media.json:",t)}function M(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",l.appendChild(t),l.appendChild(e),r=new Masonry(l,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function k(){for(;i.scrollHeight<=i.clientHeight+200;)await I()}i.addEventListener("scroll",async()=>{if(y)return;y=setTimeout(()=>y=null,100),i.scrollTop>=i.scrollHeight-i.clientHeight-500&&await I()}),b.addEventListener("click",async()=>{W(m),l.innerHTML="",p.clear(),M(),u=0,await k()});function q(){clearTimeout(v),v=setTimeout(()=>{r.layout()},100)}async function I(){if(u>=Math.ceil(m.length/h)||g>=10)return;let t=u;u++,g++;let e=m.slice(t*h,(t+1)*h),n=[];for(let o of e)!o||!o.media||p.has(o.media)||(p.add(o.media),n.push(N(o)));await Promise.all(n),r.layout(),g--}async function N(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${C}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,o=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(L++,T=o,d(),t.type==="image")return await H(n,o);if(t.type==="video")return await O(n,o);if(t.type==="url")return P(n);console.warn("Unknown type:",t.type)}function w(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function P(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=_();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let o=w(e);l.appendChild(o),r.appended(o),r.layout(),A++,d()}async function H(t,e){return s.add(e),new Promise(n=>{let o=document.createElement("img");o.src=e,o.dataset.originalSrc=e;let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),imagesLoaded(o,()=>{let c=w(a);l.appendChild(c),r.appended(c),r.layout(),$.observe(o),n(c),A++,s.delete(e),d()}),o.addEventListener("error",()=>{console.warn("Image failed to load:",e),n(null),s.delete(e),d()},{once:!0})})}async function O(t,e){return s.add(e),new Promise(n=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0,o.playsInline=!0;let a=document.createElement("source");a.src=e,o.appendChild(a);let c=document.createElement("a");c.href=t,c.target="_blank",c.rel="noopener noreferrer",c.appendChild(o);let S=()=>{s.delete(e),d()},j=()=>{let E=w(c);l.appendChild(E),r.appended(E),r.layout(),B.observe(o),n(E),A++,d(),S()},x=()=>{console.warn("Video failed to load:",e),n(null),S()};o.addEventListener("loadeddata",j,{once:!0}),o.addEventListener("error",x,{once:!0}),a.addEventListener("error",x,{once:!0})})}function W(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function _(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}});console.log("Mureinoki \xB7 2025");})();
