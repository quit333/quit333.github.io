(()=>{window.addEventListener("load",async()=>{let l=document.querySelector("article"),s=document.getElementsByClassName("gallery")[0],b=document.getElementById("top-button"),w=new Set,d=0,C="",u=[],i,g=!1,m=!1,y=5,c=new Set,$=document.createElement("div");b.appendChild($);let M=0;function f(){let t=Array.from(c).slice(0,5),e=c.size>5?` (+${c.size-5} more)`:"";$.innerHTML=`
		Items Loaded: ${M}<br>
		Loading Status: ${g}/${m}<br>
		Scroll: ${l.scrollTop}/${l.scrollHeight-l.clientHeight-500}<br>
		Pending (${c.size}): ${t.join("<br>")}${e} `}function z(t){for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}}function H(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),r=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${r})`}try{let e=await(await fetch("media.json")).json();C=e.gallery_name,u=e.items,k(),await v()}catch(t){console.error("Failed to load media.json:",t)}function k(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",s.appendChild(t),s.appendChild(e),i=new Masonry(s,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function v(){for(;l.scrollHeight<=l.clientHeight+200;)await S()}async function S(){if(!(g||m)){g=!0;try{let t=d*y;if(t>=u.length){m=!0;return}let r=u.slice(t,t+y).map(async n=>{if(!n||!n.media||w.has(n.media))return null;w.add(n.media),M++,f();let a=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${C}`,h=n.source.startsWith("http")?n.source:`${a}/${n.source}`,I=n.media.startsWith("http")?n.media:`${a}/${n.media}`;return n.type==="image"?await N(h,I):n.type==="video"?await B(h,I):n.type==="url"?L(h):(console.warn("Unknown type:",n.type),null)}),o=(await Promise.all(r)).filter(Boolean);if(d++,o.length===0){d*y>=media.length&&(m=!0);return}o.forEach(n=>s.appendChild(n)),i&&typeof i.appended=="function"&&i.appended(o),i&&typeof i.layout=="function"&&i.layout(),o.forEach(n=>{let a=n.querySelector("video");a&&p&&p.observe(a)}),d*y>=u.length&&(m=!0)}finally{g=!1}}}function E(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function L(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=H();let r=document.createElement("p");return r.textContent=t,e.appendChild(r),E(e)}async function N(t,e){return c.add(e),new Promise(r=>{let o=document.createElement("img");o.src=e;let n=document.createElement("a");n.href=t,n.target="_blank",n.rel="noopener noreferrer",n.appendChild(o),imagesLoaded(o,()=>{c.delete(e);let a=E(n);r(a),f()}),o.addEventListener("error",()=>{c.delete(e),console.warn("Image failed to load:",e),r(null),f()},{once:!0})})}async function B(t,e){return c.add(e),new Promise(r=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0;let n=document.createElement("source");n.src=e,o.appendChild(n);let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),o.addEventListener("loadeddata",()=>{c.delete(e);let h=E(a);r(h),f()},{once:!0}),o.addEventListener("error",()=>{console.warn("Video failed to load:",e),c.delete(e),r(null),f()},{once:!0})})}let p=null;function P(){p&&p.disconnect(),p=new IntersectionObserver(t=>{t.forEach(e=>{let r=e.target;r.tagName==="VIDEO"&&(e.isIntersecting?r.play().catch(o=>console.warn("Video play error:",o)):r.pause())})},{root:l,rootMargin:"250px 0px 250px 0px"})}l.addEventListener("scroll",async()=>{l.scrollTop>=l.scrollHeight-l.clientHeight-500&&await S()}),b.addEventListener("click",async()=>{z(u),s.innerHTML="",w.clear(),k(),d=0,await v()})});console.log("Mureinoki \xB7 2025");})();
