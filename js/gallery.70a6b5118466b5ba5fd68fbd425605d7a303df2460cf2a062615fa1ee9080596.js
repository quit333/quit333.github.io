(()=>{window.addEventListener("load",async()=>{let c=document.querySelector("article"),l=document.getElementsByClassName("gallery")[0],C=document.getElementById("top-button"),p=new Set,g=5,u=0,b="",m=[],s,h=0,q,f,z=document.createElement("div"),i=new Set,x=0,y=0,$="",V=!1;C.appendChild(z);function d(){let t=Array.from(i).slice(0,5),e=i.size>5?` (+${i.size-5} more)`:""}let L=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;e.isIntersecting&&n.dataset.originalSrc&&!n.complete&&(n.src=n.dataset.originalSrc)})},{root:c,rootMargin:"500px 0px 500px 0px"}),N=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;e.isIntersecting?n.play().catch(o=>console.warn("Video play error:",o)):n.pause()})},{root:c,rootMargin:"100px 0px 100px 0px"});try{let e=await(await fetch("media.json")).json();b=e.gallery_name,m=e.items,v(),await M()}catch(t){console.error("Failed to load media.json:",t)}function v(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",l.appendChild(t),l.appendChild(e),s=new Masonry(l,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function M(){for(;c.scrollHeight<=c.clientHeight+200;)await k()}c.addEventListener("scroll",async()=>{if(f)return;f=setTimeout(()=>f=null,100),c.scrollTop>=c.scrollHeight-c.clientHeight-500&&await k()}),C.addEventListener("click",async()=>{O(m),l.innerHTML="",p.clear(),v(),u=0,await M()});async function k(){if(u>=Math.ceil(m.length/g)||h>=10)return;let t=u;u++,h++;let e=m.slice(t*g,(t+1)*g);for(let n of e)!n||!n.media||p.has(n.media)||(p.add(n.media),await H(n));h--}async function H(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${b}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,o=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(x++,$=o,d(),t.type==="image")return await j(n,o);if(t.type==="video")return await B(n,o);if(t.type==="url")return T(n);console.warn("Unknown type:",t.type)}function w(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function T(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=P();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let o=w(e);l.appendChild(o),s.appended(o),s.layout(),y++,d()}async function j(t,e){return i.add(e),new Promise(n=>{let o=document.createElement("img");o.dataset.originalSrc=e,o.loading="lazy",o.src=e;let r=document.createElement("a");r.href=t,r.target="_blank",r.rel="noopener noreferrer",r.appendChild(o),imagesLoaded(o,()=>{let a=w(r);l.appendChild(a),s.appended(a),s.layout(),L.observe(o),n(a),y++,i.delete(e),d()}),o.addEventListener("error",()=>{console.warn("Image failed to load:",e),n(null),i.delete(e),d()},{once:!0})})}async function B(t,e){return i.add(e),new Promise(n=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0,o.playsInline=!0;let r=document.createElement("source");r.src=e,o.appendChild(r);let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o);let S=()=>{i.delete(e),d()},_=()=>{let E=w(a);l.appendChild(E),s.appended(E),s.layout(),N.observe(o),n(E),y++,d(),S()},I=()=>{console.warn("Video failed to load:",e),n(null),S()};o.addEventListener("loadeddata",_,{once:!0}),o.addEventListener("error",I,{once:!0}),r.addEventListener("error",I,{once:!0})})}function O(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function P(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}});console.log("Mureinoki \xB7 2025");})();
