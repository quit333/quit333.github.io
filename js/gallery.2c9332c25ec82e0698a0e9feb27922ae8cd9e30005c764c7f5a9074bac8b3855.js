(()=>{window.addEventListener("load",()=>{class m{constructor({scrollArea:t,gallery:e,minItemWidth:i=250,gap:l=10}){this.scrollArea=t,this.gallery=e,this.minItemWidth=i,this.columns=0,this.gap=l,this.colHeights=[],this.positions=[],this.visible=new Map,this.abortController=new AbortController,this.mediaQueue=[],this.readyQueue=[],this.scrollBuffer=this.scrollArea.clientHeight*1.5,this.commitScheduled=!1,this.maxUrlItemPerBatch=2,this.batchSize=4,this.onScroll=this.onScroll.bind(this)}async init(){this.reset(),await this.fetchData(),this.initColumns(),this.fillInitialViewport(),this.scrollArea.focus(),this.scrollArea.addEventListener("scroll",this.onScroll)}reset(){this.destroy(),this.abortController=new AbortController,this.gallery.style.position="relative",this.gallery.style.height="0px"}destroy(){this.abortController.abort(),this.scrollArea.removeEventListener("scroll",this.onScroll),this.clear(),this.readyQueue=[]}clear(){this.gallery.innerHTML="",this.positions=[],this.visible.clear(),this.colHeights=new Array(this.columns).fill(0),this.gallery.style.height="0px"}async fetchData(){let e=await(await fetch("media.json",{signal:this.abortController.signal})).json();this.galleryName=e.gallery_name,this.mediaQueue=e.items.slice()}initColumns(){this.currentColumns=this.getColumnCount(),this.colHeights=new Array(this.currentColumns).fill(0),this.columnWidth=(this.scrollArea.clientWidth-this.gap*(this.currentColumns-1))/this.currentColumns}getColumnCount(){return this.columns=Math.ceil(this.scrollArea.clientWidth/this.minItemWidth),Math.max(2,this.columns)}async fillInitialViewport(){for(;this.scrollArea.scrollHeight<this.scrollArea.clientHeight+this.scrollBuffer&&this.mediaQueue.length;)await this.loadNext()}async onShuffle(){this.abortController.abort(),this.abortController=new AbortController;let t=[...this.mediaQueue,...this.readyQueue.map(e=>e.media),...this.positions.map(e=>e.el?.__media).filter(Boolean)];this.shuffle(t),this.mediaQueue=t,this.readyQueue=[],this.clear(),this.initColumns(),await this.fillInitialViewport()}onScroll(){let t=this.scrollArea.scrollTop,e=t+this.scrollArea.clientHeight;this.virtualize(t,e),this.fillWhileNeeded(e)}fillWhileNeeded(t){Math.min(...this.colHeights)<t+this.scrollBuffer&&this.mediaQueue.length&&this.loadNext()}virtualize(t,e){for(let[i,l]of this.visible.entries()){let r=this.positions[i];(r.top+r.height<t-this.scrollBuffer||r.top>e+this.scrollBuffer)&&(l.remove(),this.visible.delete(i))}this.positions.forEach((i,l)=>{if(!this.visible.has(l)&&i.top+i.height>=t-this.scrollBuffer&&i.top<=e+this.scrollBuffer){let r=i.el;this.gallery.appendChild(r),this.visible.set(l,r)}})}async loadNext(){if(!this.mediaQueue.length)return;let t=this.mediaQueue.shift(),e=this.abortController.signal;try{let i=await this.createItem(t);if(i.__media=t,e.aborted)return;this.readyQueue.push({el:i,media:t}),this.scheduleCommit()}catch{}}scheduleCommit(){this.commitScheduled||(this.commitScheduled=!0,requestAnimationFrame(()=>this.commitBatch()))}commitBatch(){if(this.commitScheduled=!1,!this.readyQueue.length)return;let t=0,e=0;for(let i=0;i<this.readyQueue.length&&t<this.batchSize;i++){let l=this.readyQueue[i];l.media.type==="text"&&e>=this.maxUrlItemPerBatch||(this.readyQueue.splice(i,1),i--,this.placeItem(l.el),t++,l.media.type==="text"&&e++)}this.readyQueue.length&&this.scheduleCommit()}placeItem(t){let e=this.colHeights.indexOf(Math.min(...this.colHeights)),i=this.colHeights[e],l=e*(this.columnWidth+this.gap);t.style.position="absolute",t.style.width=`${this.columnWidth}px`,t.style.top=`${i}px`,t.style.left=`${l}px`,this.gallery.appendChild(t),t.classList.add("visible");let r=t.offsetHeight,s=this.positions.length;this.positions.push({top:i,height:r,el:t}),this.colHeights[e]+=r+this.gap,this.gallery.style.height=`${Math.max(...this.colHeights)}px`,this.visible.set(s,t)}createWrapper(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.tabIndex=-1,e}async createItem(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${this.galleryName}`,i=t.fullres?t.fullres.startsWith("http")?t.fullres:`${e}/${t.fullres}`:null,l=t.thumbnail?t.thumbnail.startsWith("http")?t.thumbnail:`${e}/${t.thumbnail}`:null,r=t.source&&t.source.startsWith("http")?t.source:null,s;if(t.type==="url"){s=document.createElement("div"),s.className="gallery-item",s.style.background=`hsl(${Math.random()*360},30%,30%)`,s.style.padding="0px",s.style.width=`${this.columnWidth}px`;let h=document.createElement("p");h.textContent=r||"",s.appendChild(h)}else t.type==="video"?(s=document.createElement("video"),s.className="gallery-item",s.controls=!1,s.src=i,s.autoplay=s.loop=s.muted=s.playsInline=!0,await a(s)):(s=document.createElement("img"),s.className="gallery-item",s.src=l||i,await a(s));let n=this.createWrapper(i);if(n.className="gallery-item-wrapper",n.appendChild(s),r&&t.type!=="url"){let h=this.createWrapper(r);h.className="gallery-source",n.appendChild(h)}return n}shuffle(t){for(let e=t.length-1;e>0;e--){let i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}}}function a(o){return new Promise((t,e)=>{o.tagName==="IMG"?(o.onload=t,o.onerror=e):o.tagName==="VIDEO"?(o.onloadedmetadata=t,o.onerror=e):t()})}let d=document.querySelector("article"),f=document.querySelector(".gallery");function c(){gallery=new m({scrollArea:d,gallery:f}),gallery.init()}document.getElementById("top-button").addEventListener("click",()=>{gallery.onShuffle()});let u=window.innerWidth;window.addEventListener("resize",function(){let o=window.innerWidth;o!==u&&(u=o,gallery.destroy(),c())}),c()});})();
