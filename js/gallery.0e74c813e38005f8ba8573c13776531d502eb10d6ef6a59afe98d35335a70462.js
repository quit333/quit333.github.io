(()=>{window.addEventListener("load",async()=>{let r=document.querySelector("article"),l=document.getElementsByClassName("gallery")[0],g=document.getElementById("top-button"),p=new Set,y=5,u=0,w="",h=[],s,E=document.createElement("div"),i=new Set,C=0,m=0,b="";g.appendChild(E);function d(){let t=Array.from(i).slice(0,5),e=i.size>5?` (+${i.size-5} more)`:"";E.innerHTML=`
		Items Loaded: ${C}<br>
		Items Appended: ${m}<br>
		Last Item: ${b}<br>
		Scroll: ${r.scrollTop}/${r.scrollHeight-r.clientHeight-500}<br>
		Pending (${i.size}): ${t.join("<br>")}${e} `}function z(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function L(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}try{let e=await(await fetch("media.json")).json();w=e.gallery_name,h=e.items,M(),await $()}catch(t){console.error("Failed to load media.json:",t)}function M(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",l.appendChild(t),l.appendChild(e),s=new Masonry(l,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function $(){for(;r.scrollHeight<=r.clientHeight+200;)await k()}async function k(){let t=h.slice(u*y,(u+1)*y),e=!1;for(let n of t)!n||!n.media||p.has(n.media)||(p.add(n.media),await H(n),e=!0);e&&u++}async function H(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${w}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,o=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(C++,b=o,d(),t.type==="image")return await j(n,o);if(t.type==="video")return await x(n,o);if(t.type==="url")return N(n);console.warn("Unknown type:",t.type)}function f(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function N(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=L();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let o=f(e);l.appendChild(o),m++,d(),s.appended(o),s.layout()}async function j(t,e){return i.add(e),new Promise(n=>{let o=document.createElement("img");o.src=e;let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),imagesLoaded(o,()=>{i.delete(e),d();let c=f(a);l.appendChild(c),m++,d(),s.appended(c),s.layout(),n(c)}),o.addEventListener("error",()=>{i.delete(e),d(),console.warn("Image failed to load:",e),n(null)},{once:!0})})}async function x(t,e){return new Promise(n=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0;let a=document.createElement("source");a.src=e,o.appendChild(a);let c=document.createElement("a");c.href=t,c.target="_blank",c.rel="noopener noreferrer",c.appendChild(o);let v=()=>{i.delete(e),d()},B=()=>{m++,d(),v();let S=f(c);l.appendChild(S),n(S)},I=()=>{console.warn("Video failed to load:",e),v(),n(null)};o.addEventListener("loadeddata",B,{once:!0}),o.addEventListener("error",I,{once:!0}),a.addEventListener("error",I,{once:!0})})}let P=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;n.tagName==="VIDEO"&&(e.isIntersecting?n.play().catch(o=>console.warn("Video play error:",o)):n.pause())})},{root:r,rootMargin:"250px 0px 250px 0px"});r.addEventListener("scroll",async()=>{r.scrollTop>=r.scrollHeight-r.clientHeight-500&&await k()}),g.addEventListener("click",async()=>{z(h),l.innerHTML="",p.clear(),M(),u=0,await $()})});console.log("Mureinoki \xB7 2025");})();
