(()=>{window.addEventListener("load",async()=>{let a=document.querySelector("article"),r=document.getElementsByClassName("gallery")[0],p=document.getElementById("top-button"),s=new Set,l=0,h="",u=[],c,g=document.createElement("div");p.appendChild(g);let f=0;function M(){g.textContent=`Items Loaded: ${f}`}function b(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function k(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}try{let e=await(await fetch("media.json")).json();h=e.gallery_name,u=e.items,y(),await w()}catch(t){console.error("Failed to load media.json:",t)}function y(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",r.appendChild(t),r.appendChild(e),c=new Masonry(r,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function w(){for(;a.scrollHeight<=a.clientHeight+200;)await C()}async function C(){let t=u.slice(l*5,(l+1)*5);for(let e of t)!e||!e.media||s.has(e.media)||(s.add(e.media),await v(e));l++}async function v(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${h}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,o=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(f++,M(),t.type==="image")return await $(n,o);if(t.type==="video")return await I(n,o);if(t.type==="url")return L(n);console.warn("Unknown type:",t.type)}function L(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=k();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let o=m(e);r.appendChild(o),c.appended(o),c.layout()}async function $(t,e){let n=document.createElement("img");n.src=e;let o=document.createElement("a");return o.href=t,o.target="_blank",o.rel="noopener noreferrer",o.appendChild(n),new Promise(i=>{imagesLoaded(n,()=>{let d=m(o);r.appendChild(d),c.appended(d),c.layout(),i()})})}async function I(t,e){let n=document.createElement("video");n.autoplay=!0,n.loop=!0,n.muted=!0;let o=document.createElement("source");o.src=e,n.appendChild(o);let i=document.createElement("a");return i.href=t,i.target="_blank",i.rel="noopener noreferrer",i.appendChild(n),new Promise(d=>{n.addEventListener("loadeddata",()=>{let E=m(i);r.appendChild(E),c.appended(E),c.layout(),N.observe(n),d()}),n.addEventListener("error",()=>{console.warn("Video failed to load:",e),d()})})}let N=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;n.tagName==="VIDEO"&&(e.isIntersecting?n.play().catch(o=>console.warn("Video play error:",o)):n.pause())})},{root:a,rootMargin:"250px 0px 250px 0px"});function m(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}a.addEventListener("scroll",async()=>{a.scrollTop>=a.scrollHeight-a.clientHeight-500&&await C()}),p.addEventListener("click",async()=>{b(u),r.innerHTML="",s.clear(),y(),l=0,await w()})});console.log("Mureinoki \xB7 2025");})();
