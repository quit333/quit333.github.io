(()=>{window.addEventListener("load",async()=>{let c=document.querySelector("article"),i=document.getElementsByClassName("gallery")[0],C=document.getElementById("top-button"),p=new Set,h=5,u=0,M="",m=[],d,f=0,L=document.createElement("div"),s=new Set,S=0,g=0,$="",_=!1;C.appendChild(L);function l(){let t=Array.from(s).slice(0,5),e=s.size>5?` (+${s.size-5} more)`:""}try{let e=await(await fetch("media.json")).json();M=e.gallery_name,m=e.items,b(),await v()}catch(t){console.error("Failed to load media.json:",t)}function b(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",i.appendChild(t),i.appendChild(e),d=new Masonry(i,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function v(){for(;c.scrollHeight<=c.clientHeight+200;)await k()}let y;c.addEventListener("scroll",async()=>{if(y)return;y=setTimeout(()=>y=null,100),c.scrollTop>=c.scrollHeight-c.clientHeight-500&&await k()}),C.addEventListener("click",async()=>{B(m),i.innerHTML="",p.clear(),b(),u=0,await v()});async function k(){if(u>=Math.ceil(m.length/h)||f>=10)return;let t=u;u++,f++;let e=m.slice(t*h,(t+1)*h),o=[];for(let n of e)!n||!n.media||p.has(n.media)||(p.add(n.media),o.push(N(n)));await Promise.all(o),d.layout(),f--}async function N(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${M}`,o=t.source.startsWith("http")?t.source:`${e}/${t.source}`,n=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(S++,$=n,l(),t.type==="image")return await x(o,n);if(t.type==="video")return await H(o,n);if(t.type==="url")return P(o);console.warn("Unknown type:",t.type)}function w(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function P(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=T();let o=document.createElement("p");o.textContent=t,e.appendChild(o);let n=w(e);i.appendChild(n),d.appended(n),g++,l()}async function x(t,e){return s.add(e),new Promise(o=>{let n=document.createElement("img");n.src=e;let r=document.createElement("a");r.href=t,r.target="_blank",r.rel="noopener noreferrer",r.appendChild(n),imagesLoaded(n,()=>{let a=w(r);i.appendChild(a),d.appended(a),o(a),g++,s.delete(e),l()}),n.addEventListener("error",()=>{console.warn("Image failed to load:",e),o(null),s.delete(e),l()},{once:!0})})}async function H(t,e){return new Promise(o=>{let n=document.createElement("video");n.autoplay=!0,n.loop=!0,n.muted=!0;let r=document.createElement("source");r.src=e,n.appendChild(r);let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(n);let z=()=>{s.delete(e),l()},V=()=>{let E=w(a);i.appendChild(E),d.appended(E),j.observe(n),o(E),g++,l(),z()},I=()=>{console.warn("Video failed to load:",e),o(null),z()};n.addEventListener("loadeddata",V,{once:!0}),n.addEventListener("error",I,{once:!0}),r.addEventListener("error",I,{once:!0})})}let j=new IntersectionObserver(t=>{t.forEach(e=>{let o=e.target;o.tagName==="VIDEO"&&(e.isIntersecting?o.play().catch(n=>console.warn("Video play error:",n)):o.pause())})},{root:c,rootMargin:"250px 0px 250px 0px"});function B(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}}function T(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}});console.log("Mureinoki \xB7 2025");})();
