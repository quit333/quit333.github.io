(()=>{window.addEventListener("load",async()=>{let c=document.querySelector("article"),p=document.getElementsByClassName("gallery")[0],C=document.getElementById("top-button"),m=5,w=0,I,v,y,u,h,g;class L{constructor(e,s=5,l=10,a=15){this.RowDeleteTop=0,this.gaps=l,this.gallery=e,this.gallery.style.position="relative",this.itemCache=[],this.columns=s,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=a,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,e.title=`column: ${this.columnIndex} | row: ${this.rowIndex}`,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>{e.classList.add("visible")})}restore(e){requestAnimationFrame(()=>{e.classList.add("visible")})}virtualize(e){if(this.rowIndex>this.virtRowThreshold){let s=this.rowIndex-this.virtRowThreshold,l=Array.from(this.gallery.children).find(o=>parseInt(o.dataset.row)===s&&parseInt(o.dataset.column)===0);if(!l)return;this.rowDeleteTop=l.offsetTop;let a=e.scrollTop,d=Array.from(this.gallery.children).filter(o=>{let n=parseInt(o.dataset.row)<s,i=o.offsetTop+o.offsetHeight<a;return n&&i});this.onRowVirtualized(this.rowDeleteTop),d.forEach(o=>{this.itemCache.some(i=>i[0]===o.dataset.jsonIndex)||(this.itemCache.push([o.dataset.jsonIndex,o.dataset.row,o.offsetTop,o.offsetLeft,o.offsetWidth,o.offsetHeight]),o.remove())})}}}async function b(t=!1){try{let s=await(await fetch("media.json")).json();u=[],y=!1,I=0,g=0,v=s.gallery_name,u=s.items,t&&W(u),k()}catch(e){console.error("Failed to load media.json:",e)}}async function k(){$(),await R()}function $(){h=new L(p,5,10),h.onRowVirtualized=t=>{g=t}}c.addEventListener("scroll",async()=>{let t=c.scrollTop,e=t>=c.scrollHeight-c.clientHeight-500,s=g!==0&&t<=g+500;e&&!y?(y=!0,M().finally(()=>{y=!1,h.virtualize(c)})):s&&H(h)}),C.addEventListener("click",async()=>{w++,h=null,p.innerHTML="",await b(!0)});async function R(){for(;c.scrollHeight<=c.clientHeight+500;)M(),await new Promise(t=>requestAnimationFrame(t))}async function M(){let t=I++,e=u.slice(t*m,(t+1)*m);e.length!==0&&e.forEach(s=>{let l=u.indexOf(s);!s||!s.preview||E(s,l).catch(a=>console.warn(a))})}function H(t){if(t.itemCache.length===0)return;t.itemCache.splice(-m,m).forEach(([s,l,a,d,o,n])=>{let i=u[s],r=document.createElement("div");r.className="gallery-item",r.style.position="absolute",r.style.width=o+"px",r.style.height=n+"px",r.style.left=d+"px",r.style.top=a+"px",r.dataset.jsonIndex=s,r.dataset.row=l,r.dataset.gallerySession=w,E(i,s,r)})}async function E(t,e,s=null){let l=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${v}`,a=t.source.startsWith("http")?t.source:`${l}/${t.source}?raw=true`,d=t.preview.startsWith("http")?t.preview:`${l}/${t.preview}?raw=true`;return t.type==="image"||t.type==="video"||t.type==="url"?await P(t.type,a,d,e,s):(console.warn("Unknown type:",t.type),null)}function D(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}async function P(t,e,s,l,a=null){return new Promise(d=>{let o=D(e),n,i=null;switch(t){case"image":n=document.createElement("img"),n.src=s;break;case"video":n=document.createElement("video");let x=document.createElement("source");x.src=s,n.autoplay=!0,n.loop=!0,n.muted=!0,n.playsInline=!0,n.appendChild(x),i=x;break;case"url":n=document.createElement("p"),n.textContent=e,o.id="link-card",o.style.backgroundColor=j();break}o.appendChild(n);let r=a,T=!1;r?T=!0:(r=document.createElement("div"),r.className="gallery-item",r.dataset.jsonIndex=l,r.dataset.gallerySession=w),r.appendChild(o);let f=S(d,r,T);t==="image"?imagesLoaded(n).on("done",f.success).on("fail",f.error):t==="video"?(n.addEventListener("loadeddata",f.success,{once:!0}),n.addEventListener("error",f.error,{once:!0}),i!==null&&i.addEventListener("error",()=>f.error(),{once:!0})):t==="url"&&f.success()})}function S(t,e,s){return{success:()=>{if(parseInt(e.dataset.gallerySession)!==w)return e.remove(),t(null);s===!1?(p.appendChild(e),h.append(e)):(p.prepend(e),h.restore(e)),t(e)},error:()=>{console.warn("Media didn't resolve."),t(null)}}}function W(t){for(let e=t.length-1;e>0;e--){let s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}}function j(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),s=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${s})`}b(),console.log("Mureinoki \xB7 2025")});})();
