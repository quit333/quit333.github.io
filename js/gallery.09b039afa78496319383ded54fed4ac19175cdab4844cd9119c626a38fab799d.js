(()=>{window.addEventListener("load",async()=>{let r=document.querySelector("article"),i=document.getElementsByClassName("gallery")[0],E=document.getElementById("top-button"),h=new Set,g=5,d=0,C="",u=[],m,f=0,$=document.createElement("div"),l=new Set,M=0,p=0,v="",_=!1;E.appendChild($);function s(){let t=Array.from(l).slice(0,5),e=l.size>5?` (+${l.size-5} more)`:"";$.innerHTML=`
			Items Loaded: ${M}<br>
			Items Appended: ${p}<br>
			Page: ${d}/${u.length/5}<br>
			Last Item: ${v}<br>
			ScrollFill: ${r.scrollHeight}<=?${r.clientHeight+200}<br>
			ScrollAdd: ${r.scrollTop}>=?${r.scrollHeight-r.clientHeight-500}<br>
			Pending (${l.size}): ${t.join("<br>")}${e} `}try{let e=await(await fetch("media.json")).json();C=e.gallery_name,u=e.items,k(),await I()}catch(t){console.error("Failed to load media.json:",t)}function k(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",i.appendChild(t),i.appendChild(e),m=new Masonry(i,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function I(){for(;r.scrollHeight<=r.clientHeight+200;)await L()}let y;r.addEventListener("scroll",async()=>{if(y)return;y=setTimeout(()=>y=null,100),r.scrollTop>=r.scrollHeight-r.clientHeight-500&&await L()}),E.addEventListener("click",async()=>{x(u),i.innerHTML="",h.clear(),k(),d=0,await I()});async function L(){if(d>=Math.ceil(u.length/g)||f>=10)return;let t=d;d++,f++;let e=u.slice(t*g,(t+1)*g),o=[];for(let n of e)!n||!n.media||h.has(n.media)||(h.add(n.media),o.push(H(n)));await Promise.all(o),m.layout(),f--}async function H(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${C}`,o=t.source.startsWith("http")?t.source:`${e}/${t.source}`,n=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(M++,v=n,s(),t.type==="image")return await N(o,n);if(t.type==="video")return await T(o,n);if(t.type==="url")return P(o);console.warn("Unknown type:",t.type)}function w(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function P(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=B();let o=document.createElement("p");o.textContent=t,e.appendChild(o);let n=w(e);i.appendChild(n),m.appended(n),p++,s()}async function N(t,e){return l.add(e),new Promise(o=>{let n=document.createElement("img");n.src=e;let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(n),imagesLoaded(n,()=>{let c=w(a);i.appendChild(c),m.appended(c),o(c),p++,l.delete(e),s()}),n.addEventListener("error",()=>{console.warn("Image failed to load:",e),o(null),l.delete(e),s()},{once:!0})})}async function T(t,e){return new Promise(o=>{let n=document.createElement("video");n.autoplay=!0,n.loop=!0,n.muted=!0;let a=document.createElement("source");a.src=e,n.appendChild(a);let c=document.createElement("a");c.href=t,c.target="_blank",c.rel="noopener noreferrer",c.appendChild(n);let S=()=>{l.delete(e),s()},V=()=>{let b=w(c);i.appendChild(b),m.appended(b),j.observe(n),o(b),p++,s(),S()},z=()=>{console.warn("Video failed to load:",e),o(null),S()};n.addEventListener("loadeddata",V,{once:!0}),n.addEventListener("error",z,{once:!0}),a.addEventListener("error",z,{once:!0})})}let j=new IntersectionObserver(t=>{t.forEach(e=>{let o=e.target;o.tagName==="VIDEO"&&(e.isIntersecting?o.play().catch(n=>console.warn("Video play error:",n)):o.pause())})},{root:r,rootMargin:"250px 0px 250px 0px"});function x(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}}function B(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}});console.log("Mureinoki \xB7 2025");})();
