(()=>{window.addEventListener("load",()=>{let a=document.querySelector("article"),w=document.querySelector(".gallery"),C=document.getElementById("top-button"),b,x=a.clientHeight,v=0,I=[],g=!1,u=null,y=0;class S{constructor(e,o,n=5,r=10,l=15){this.scrollArea=e,this.gallery=o,this.gallery.style.position="relative",this.itemCache=[],this.gaps=r,this.columns=n,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=l,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,e.title=`column: ${this.columnIndex} | row: ${this.rowIndex}`,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>e.classList.add("visible"))}restore(e){requestAnimationFrame(()=>e.classList.add("visible"))}virtualize(){if(this.rowIndex<=this.virtRowThreshold)return;let e=this.rowIndex-this.virtRowThreshold,o=Array.from(this.gallery.children).find(r=>parseInt(r.dataset.row)===e&&parseInt(r.dataset.column)===0);if(!o)return;this.rowDeleteTop=o.offsetTop,this.onRowVirtualized(this.rowDeleteTop);let n=this.scrollArea.scrollTop;Array.from(this.gallery.children).forEach(r=>{parseInt(r.dataset.row)<e&&r.offsetTop+r.offsetHeight<this.scrollArea.scrollTop&&(this.itemCache.some(l=>l[0]===r.dataset.jsonIndex)||this.itemCache.push([r.dataset.jsonIndex,r.dataset.row,r.offsetTop,r.offsetLeft,r.offsetWidth,r.offsetHeight]),r.remove())})}}let A=(()=>{let t=null;function e(){return t||(t=fetch("media.json").then(o=>{if(!o.ok)throw new Error("Failed to load media.json");return o.json()})),t}return{load:e}})();class ${constructor(){this.controller=new AbortController,this.signal=this.controller.signal,this.cleanups=new Set}run(e){if(!this.signal.aborted)return e(this.signal,this.onCleanup.bind(this))}onCleanup(e){this.cleanups.add(e)}dispose(){this.controller.abort();for(let e of this.cleanups)try{e()}catch{}this.cleanups.clear()}}let f=null;async function E(t=!1){f?.dispose(),f=new $,f.run((o,n)=>{let r=()=>{let l=a.scrollTop>=a.scrollHeight-a.clientHeight-x,d=y!==0&&a.scrollTop<=y+x;l&&!g?(g=!0,M(f),u.virtualize(),g=!1):d&&f.run((h,c)=>R(u,h,c))};a.addEventListener("scroll",r),n(()=>a.removeEventListener("scroll",r))});let e=await A.load();u=null,w.innerHTML="",v=0,g=!1,y=0,b=e.gallery_name,I=t?W(e.items):e.items,z(f)}function z(t){t.run((e,o)=>{u=new S(a,w,window.innerWidth<=767?2:5,10),o(()=>u.destroy?.()),u.onRowVirtualized=n=>y=n,H(e,o)})}function H(t,e){let o;function n(){t.aborted||(a.scrollHeight<=a.clientHeight+x&&M(f),o=requestAnimationFrame(n))}o=requestAnimationFrame(n),e(()=>cancelAnimationFrame(o))}function M(t){if(!t||t.signal.aborted)return;let o=v++*5,n=I.slice(o,o+5);n.length!==0&&n.forEach((r,l)=>{if(!r?.preview)return;let d=o+l;t.run((h,c)=>T(r,d,null,h,c))})}function R(t,e,o){if(e.aborted)return;t.itemCache.splice(-5,5).forEach(([r,l,d,h,c,i])=>{let p=I[r],s=document.createElement("div");s.className="gallery-item loading",s.style.position="absolute",s.style.width=c+"px",s.style.height=i+"px",s.style.left=h+"px",s.style.top=d+"px",s.dataset.jsonIndex=r,s.dataset.row=l,o(()=>s.remove()),T(p,r,s,e,o)})}function T(t,e,o=null,n,r){if(n.aborted)return;let l=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${b}`,d=t.source.startsWith("http")?t.source:`${l}/${t.source}?raw=true`,h=t.preview.startsWith("http")?t.preview:`${l}/${t.preview}?raw=true`;return q(t.type,d,h,e,o,n,r)}function k(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}function q(t,e,o,n,r=null,l,d){return new Promise(h=>{if(l.aborted)return;let c=k(e),i,p;t==="image"?(i=document.createElement("img"),i.src=o):t==="video"?(i=document.createElement("video"),p=document.createElement("source"),p.src=o,i.appendChild(p),i.autoplay=i.loop=i.muted=i.playsInline=!0):(i=document.createElement("p"),i.textContent=e,c.id="link-card",c.style.backgroundColor=j()),c.appendChild(i);let s=r,L=!1;s?(L=!0,w.prepend(s),u.restore(s)):(s=document.createElement("div"),s.className="gallery-item",s.dataset.jsonIndex=n),s.appendChild(c),d(()=>s.remove());let m=P(h,s,L,l);t==="image"?imagesLoaded(i).on("done",m.success).on("fail",m.error):t==="video"?(i.addEventListener("loadeddata",m.success,{once:!0}),i.addEventListener("error",m.error,{once:!0}),p&&p.addEventListener("error",()=>m.error(),{once:!0})):m.success()})}function P(t,e,o,n){return{success:()=>{if(n.aborted)return t(null);o?e.classList.remove("loading"):(w.appendChild(e),u.append(e)),t(e)},error:()=>{console.error("Media didn't resolve."),t(null)}}}function W(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}function j(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}C.addEventListener("click",()=>E(!0)),E(),console.log("Mureinoki \xB7 2025")});})();
