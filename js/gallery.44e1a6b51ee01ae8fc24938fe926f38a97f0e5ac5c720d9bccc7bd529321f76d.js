(()=>{window.addEventListener("load",()=>{class d{constructor({scrollArea:t,columns:e=5,gap:i=10}){this.scrollArea=t,this.gallery=t.querySelector(".gallery"),this.columns=e,this.gap=i,this.colHeights=[],this.positions=[],this.visible=new Map,this.abortController=new AbortController,this.mediaQueue=[],this.readyQueue=[],this.viewportHeight=t.clientHeight,this.scrollBuffer=this.viewportHeight*1.5,this.commitScheduled=!1,this.maxTextPerBatch=2,this.batchSize=4,this.onScroll=this.onScroll.bind(this)}shuffle(t){for(let e=t.length-1;e>0;e--){let i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}}getColumnCount(){return this.scrollArea.clientHeight>this.scrollArea.clientWidth?2:this.columns}async init(){this.reset(),await this.fetchData(),this.initColumns(),this.fillInitialViewport(),this.scrollArea.focus(),this.scrollArea.addEventListener("scroll",this.onScroll)}clearLayout(){this.gallery.innerHTML="",this.positions=[],this.visible.clear(),this.colHeights=new Array(this.columns).fill(0),this.gallery.style.height="0px"}destroy(){this.abortController.abort(),this.scrollArea.removeEventListener("scroll",this.onScroll),this.clearLayout(),this.readyQueue=[]}async shuffleAndReload(){this.abortController.abort(),this.abortController=new AbortController;let t=[...this.mediaQueue,...this.readyQueue.map(e=>e.media),...this.positions.map(e=>e.el?.__media).filter(Boolean)];this.shuffle(t),this.mediaQueue=t,this.readyQueue=[],this.clearLayout(),this.initColumns(),await this.fillInitialViewport()}reset(){this.destroy(),this.abortController=new AbortController,this.gallery.style.position="relative",this.gallery.style.height="0px"}async fetchData(){let e=await(await fetch("media.json",{signal:this.abortController.signal})).json();this.galleryName=e.gallery_name,this.mediaQueue=e.items.slice()}initColumns(){this.currentColumns=this.getColumnCount(),this.colHeights=new Array(this.currentColumns).fill(0),this.columnWidth=(this.scrollArea.clientWidth-this.gap*(this.currentColumns-1))/this.currentColumns}async fillInitialViewport(){for(;this.scrollArea.scrollHeight<this.viewportHeight+this.scrollBuffer&&this.mediaQueue.length;)await this.loadNext()}onScroll(){let t=this.scrollArea.scrollTop,e=t+this.viewportHeight;this.virtualize(t,e),this.fillWhileNeeded(e)}fillWhileNeeded(t){Math.min(...this.colHeights)<t+this.scrollBuffer&&this.mediaQueue.length&&this.loadNext()}virtualize(t,e){for(let[i,r]of this.visible.entries()){let l=this.positions[i];(l.top+l.height<t-this.scrollBuffer||l.top>e+this.scrollBuffer)&&(r.remove(),this.visible.delete(i))}this.positions.forEach((i,r)=>{if(!this.visible.has(r)&&i.top+i.height>=t-this.scrollBuffer&&i.top<=e+this.scrollBuffer){let l=i.el;this.gallery.appendChild(l),this.visible.set(r,l)}})}async loadNext(){if(!this.mediaQueue.length)return;let t=this.mediaQueue.shift(),e=this.abortController.signal;try{let i=await this.createItem(t);if(i.__media=t,e.aborted)return;this.readyQueue.push({el:i,media:t}),this.scheduleCommit()}catch{}}scheduleCommit(){this.commitScheduled||(this.commitScheduled=!0,requestAnimationFrame(()=>this.commitBatch()))}commitBatch(){if(this.commitScheduled=!1,!this.readyQueue.length)return;let t=0,e=0;for(let i=0;i<this.readyQueue.length&&t<this.batchSize;i++){let r=this.readyQueue[i];r.media.type==="text"&&e>=this.maxTextPerBatch||(this.readyQueue.splice(i,1),i--,this.placeItem(r.el),t++,r.media.type==="text"&&e++)}this.readyQueue.length&&this.scheduleCommit()}placeItem(t){let e=this.colHeights.indexOf(Math.min(...this.colHeights)),i=this.colHeights[e],r=e*(this.columnWidth+this.gap);t.style.position="absolute",t.style.width=`${this.columnWidth}px`,t.style.top=`${i}px`,t.style.left=`${r}px`,this.gallery.appendChild(t),t.classList.add("visible");let l=t.offsetHeight,s=this.positions.length;this.positions.push({top:i,height:l,el:t}),this.colHeights[e]+=l+this.gap,this.gallery.style.height=`${Math.max(...this.colHeights)}px`,this.visible.set(s,t)}createWrapper(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.tabIndex=-1,e}async createItem(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${this.galleryName}`,i=t.fullres?t.fullres.startsWith("http")?t.fullres:`${e}/${t.fullres}?raw=true`:null,r=t.thumbnail?t.thumbnail.startsWith("http")?t.thumbnail:`${e}/${t.thumbnail}?raw=true`:null,l=t.source&&t.source.startsWith("http")?t.source:null,s;if(t.type==="url"){s=document.createElement("div"),s.className="gallery-item",s.style.background=`hsl(${Math.random()*360},30%,30%)`,s.style.padding="0px",s.style.width=`${this.columnWidth}px`;let h=document.createElement("p");h.textContent=l||"",s.appendChild(h)}else t.type==="video"?(s=document.createElement("video"),s.className="gallery-item",s.src=i,s.controls=!1,t.autoplay=t.loop=t.muted=!0,await c(s)):(s=document.createElement("img"),s.className="gallery-item",s.src=r||i,await c(s));let n=this.createWrapper(i);if(n.className="gallery-item-wrapper",n.appendChild(s),l&&t.type!=="url"){let h=this.createWrapper(l);h.className="gallery-source",n.appendChild(h)}return n}}function c(o){return new Promise((t,e)=>{o.tagName==="IMG"?(o.onload=t,o.onerror=e):o.tagName==="VIDEO"?(o.onloadedmetadata=t,o.onerror=e):t()})}let m=document.querySelector("article"),a;function u(){a=new d({scrollArea:m}),a.init()}document.getElementById("top-button").addEventListener("click",()=>{a.shuffleAndReload()}),window.addEventListener("resize",()=>{a.destroy(),u()}),u()});})();
