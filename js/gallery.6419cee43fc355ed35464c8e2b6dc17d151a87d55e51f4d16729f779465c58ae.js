(()=>{window.addEventListener("load",async()=>{let r=document.querySelector("article"),o=document.getElementById("gallery"),w=document.getElementById("top-button"),s=0,p="",l=[],m=new Set,c;try{let e=await(await fetch("media.json")).json();p=e.gallery_name,l=e.items;let n=document.createElement("div");n.className="grid-sizer";let a=document.createElement("div");a.className="gutter-sizer",o.appendChild(n),o.appendChild(a),h(),await g()}catch(t){console.error("Failed to load media.json:",t)}function h(){c=new Masonry(o,{itemSelector:".gallery-item",columnWidth:".grid-sizer",percentPosition:!0,gutter:".gutter-sizer"})}async function g(){for(;r.scrollHeight<=r.clientHeight+200;)await f()}async function f(){let t=l.slice(s*5,(s+1)*5);for(let e of t)!e||!e.media||m.has(e.media)||(m.add(e.media),await E(e));s++}async function E(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${p}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,a=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if(t.type==="image")return await C(n,a);if(t.type==="video")return await b(n,a);if(t.type==="url")return M(n);console.warn("Unknown type:",t.type)}async function C(t,e){let n=document.createElement("img");n.src=e;let a=document.createElement("a");return a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(n),new Promise(i=>{imagesLoaded(n,()=>{let d=u(a);o.appendChild(d),c.appended(d),c.layout(),i()})})}async function b(t,e){let n=document.createElement("video");n.autoplay=!0,n.loop=!0,n.muted=!0;let a=document.createElement("source");a.src=e,n.appendChild(a);let i=document.createElement("a");return i.href=t,i.target="_blank",i.rel="noopener noreferrer",i.appendChild(n),new Promise(d=>{n.addEventListener("loadeddata",()=>{let y=u(i);o.appendChild(y),c.appended(y),c.layout(),v.observe(n),d()}),n.addEventListener("error",()=>{console.warn("Video failed to load:",e),d()})})}function M(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=z();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let a=u(e);o.appendChild(a),c.appended(a),c.layout()}function u(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}let v=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;n.tagName==="VIDEO"&&(e.isIntersecting?n.play().catch(a=>console.warn("Video play error:",a)):n.pause())})},{root:r,rootMargin:"250px 0px 250px 0px"});w.addEventListener("click",async()=>{k(l),o.innerHTML="";let t=document.createElement("div");t.className="grid-sizer",o.appendChild(t),m.clear(),h(),s=0,await g()}),r.addEventListener("scroll",async()=>{r.scrollTop>=r.scrollHeight-r.clientHeight-500&&await f()});function k(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function z(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}});})();
