(()=>{window.addEventListener("load",()=>{let i=document.querySelector("article"),u=document.getElementsByClassName("gallery")[0],$=document.getElementById("top-button"),f=5,x=i.clientHeight*1,p=0,v=0,E,m=!1,w=[],c=null,g=0;class H{constructor(e,o,l=5,s=10,a=15){this.scrollArea=e,this.gallery=o,this.gallery.style.position="relative",this.itemCache=[],this.gaps=s,this.columns=l,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=a,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,e.title=`column: ${this.columnIndex} | row: ${this.rowIndex}`,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>e.classList.add("visible"))}restore(e){requestAnimationFrame(()=>e.classList.add("visible"))}virtualize(){if(this.rowIndex<=this.virtRowThreshold)return;let e=this.rowIndex-this.virtRowThreshold,o=Array.from(this.gallery.children).find(s=>parseInt(s.dataset.row)===e&&parseInt(s.dataset.column)===0);if(!o)return;this.rowDeleteTop=o.offsetTop,this.onRowVirtualized(this.rowDeleteTop);let l=this.scrollArea.scrollTop;Array.from(this.gallery.children).forEach(s=>{parseInt(s.dataset.row)<e&&s.offsetTop+s.offsetHeight<this.scrollArea.scrollTop&&(this.itemCache.some(a=>a[0]===s.dataset.jsonIndex)||this.itemCache.push([s.dataset.jsonIndex,s.dataset.row,s.offsetTop,s.offsetLeft,s.offsetWidth,s.offsetHeight]),s.remove())})}}let R=(()=>{let t=null;function e(){return t||(t=fetch("media.json").then(o=>{if(!o.ok)throw new Error("Failed to load media.json");return o.json()})),t}return{load:e}})(),I=Promise.resolve();function M(t=!1){return I=I.then(()=>k(t)),I}async function k(t=!1){let e=await R.load();p++,c=null,u.innerHTML="",v=0,m=!1,g=0,E=e.gallery_name,w=t?z(e.items):e.items,A()}function A(){c=new H(i,u,B(),10),c.onRowVirtualized=t=>g=t,S()}function S(){function t(){i.scrollHeight<=i.clientHeight+x&&(b(),requestAnimationFrame(t))}t()}function b(){let t=v++,e=w.slice(t*f,(t+1)*f);e.length!==0&&e.forEach(o=>{if(!o?.preview)return;let l=w.indexOf(o);T(o,l)})}function P(t){t.itemCache.splice(-f,f).forEach(([o,l,s,a,d,r])=>{let y=w[o],n=document.createElement("div");n.className="gallery-item loading",n.style.position="absolute",n.style.width=d+"px",n.style.height=r+"px",n.style.left=a+"px",n.style.top=s+"px",n.dataset.jsonIndex=o,n.dataset.row=l,n.dataset.gallerySession=p,T(y,o,n)})}function T(t,e,o=null){let l=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${E}`,s=t.source.startsWith("http")?t.source:`${l}/${t.source}?raw=true`,a=t.preview.startsWith("http")?t.preview:`${l}/${t.preview}?raw=true`;return j(t.type,s,a,e,o)}function W(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}function j(t,e,o,l,s=null){return new Promise(a=>{let d=W(e),r,y;if(t==="image")r=document.createElement("img"),r.src=o;else if(t==="video"){r=document.createElement("video");let L=document.createElement("source");L.src=o,r.appendChild(L),r.autoplay=r.loop=r.muted=r.playsInline=!0}else r=document.createElement("p"),r.textContent=e,d.id="link-card",d.style.backgroundColor=D();d.appendChild(r);let n=s,C=!1;n?(C=!0,u.prepend(n),c.restore(n)):(n=document.createElement("div"),n.className="gallery-item",n.dataset.jsonIndex=l,n.dataset.gallerySession=p),n.appendChild(d);let h=q(a,n,C);t==="image"?imagesLoaded(r).on("done",h.success).on("fail",h.error):t==="video"?(r.addEventListener("loadeddata",h.success,{once:!0}),r.addEventListener("error",h.error,{once:!0}),y&&y.src.addEventListener("error",()=>h.error(),{once:!0})):h.success()})}function q(t,e,o){return{success:()=>{if(parseInt(e.dataset.gallerySession)!==p)return e.remove(),t(null);o?e.classList.remove("loading"):(u.appendChild(e),c.append(e)),t(e)},error:()=>{console.error("Media didn't resolve."),t(null)}}}function z(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}function D(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}function B(){return window.innerWidth<=767?2:5}i.addEventListener("scroll",()=>{let t=i.scrollTop>=i.scrollHeight-i.clientHeight-x,e=g!==0&&i.scrollTop<=g+x;t&&!m?(m=!0,b(),c.virtualize(),m=!1):e&&P(c)}),$.addEventListener("click",()=>M(!0)),M(),console.log("Mureinoki \xB7 2025")});})();
