(()=>{window.addEventListener("load",async()=>{function L(){return window.innerWidth<=767?2:5}let k=10,c=document.querySelector("article"),p=document.getElementsByClassName("gallery")[0],$=document.getElementById("top-button"),w=5,I=c.clientHeight*1,m=0,v,b,y,u,h,g;class H{constructor(e,s=5,l=10,a=15){this.RowDeleteTop=0,this.gaps=l,this.gallery=e,this.gallery.style.position="relative",this.itemCache=[],this.columns=s,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=a,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,e.title=`column: ${this.columnIndex} | row: ${this.rowIndex}`,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>{e.classList.add("visible")})}restore(e){requestAnimationFrame(()=>{e.classList.add("visible")})}virtualize(e){if(this.rowIndex>this.virtRowThreshold){let s=this.rowIndex-this.virtRowThreshold,l=Array.from(this.gallery.children).find(n=>parseInt(n.dataset.row)===s&&parseInt(n.dataset.column)===0);if(!l)return;this.rowDeleteTop=l.offsetTop;let a=e.scrollTop,d=Array.from(this.gallery.children).filter(n=>{let o=parseInt(n.dataset.row)<s,i=n.offsetTop+n.offsetHeight<a;return o&&i});this.onRowVirtualized(this.rowDeleteTop),d.forEach(n=>{this.itemCache.some(i=>i[0]===n.dataset.jsonIndex)||(this.itemCache.push([n.dataset.jsonIndex,n.dataset.row,n.offsetTop,n.offsetLeft,n.offsetWidth,n.offsetHeight]),n.remove())})}}}async function M(t=!1){try{let s=await(await fetch("media.json")).json();u=[],y=!1,v=0,g=0,b=s.gallery_name,u=s.items,t&&q(u),R()}catch(e){console.error("Failed to load media.json:",e)}}async function R(){W(),await D()}function W(){h=new H(p,L(),k),h.onRowVirtualized=t=>{g=t}}c.addEventListener("scroll",async()=>{let t=c.scrollTop,e=t>=c.scrollHeight-c.clientHeight-I,s=g!==0&&t<=g+I;e&&!y?(y=!0,E().finally(()=>{y=!1,h.virtualize(c)})):s&&P(h)}),$.addEventListener("click",async()=>{m++,h=null,p.innerHTML="",await M(!0)});async function D(){for(;c.scrollHeight<=c.clientHeight+500;)E(),await new Promise(t=>requestAnimationFrame(t))}async function E(){let t=v++,e=u.slice(t*w,(t+1)*w);e.length!==0&&e.forEach(s=>{let l=u.indexOf(s);!s||!s.preview||C(s,l).catch(a=>console.warn(a))})}function P(t){if(t.itemCache.length===0)return;t.itemCache.splice(-w,w).forEach(([s,l,a,d,n,o])=>{let i=u[s],r=document.createElement("div");r.className="gallery-item",r.style.position="absolute",r.style.width=n+"px",r.style.height=o+"px",r.style.left=d+"px",r.style.top=a+"px",r.dataset.jsonIndex=s,r.dataset.row=l,r.dataset.gallerySession=m,C(i,s,r)})}async function C(t,e,s=null){let l=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${b}`,a=t.source.startsWith("http")?t.source:`${l}/${t.source}?raw=true`,d=t.preview.startsWith("http")?t.preview:`${l}/${t.preview}?raw=true`;return t.type==="image"||t.type==="video"||t.type==="url"?await j(t.type,a,d,e,s):(console.warn("Unknown type:",t.type),null)}function S(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}async function j(t,e,s,l,a=null){return new Promise(d=>{let n=S(e),o,i=null;switch(t){case"image":o=document.createElement("img"),o.src=s;break;case"video":o=document.createElement("video");let x=document.createElement("source");x.src=s,o.autoplay=!0,o.loop=!0,o.muted=!0,o.playsInline=!0,o.appendChild(x),i=x;break;case"url":o=document.createElement("p"),o.textContent=e,n.id="link-card",n.style.backgroundColor=z();break}n.appendChild(o);let r=a,T=!1;r?T=!0:(r=document.createElement("div"),r.className="gallery-item",r.dataset.jsonIndex=l,r.dataset.gallerySession=m),r.appendChild(n);let f=A(d,r,T);t==="image"?imagesLoaded(o).on("done",f.success).on("fail",f.error):t==="video"?(o.addEventListener("loadeddata",f.success,{once:!0}),o.addEventListener("error",f.error,{once:!0}),i!==null&&i.addEventListener("error",()=>f.error(),{once:!0})):t==="url"&&f.success()})}function A(t,e,s){return{success:()=>{if(parseInt(e.dataset.gallerySession)!==m)return e.remove(),t(null);s===!1?(p.appendChild(e),h.append(e)):(p.prepend(e),h.restore(e)),t(e)},error:()=>{console.warn("Media didn't resolve."),t(null)}}}function q(t){for(let e=t.length-1;e>0;e--){let s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}}function z(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),s=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${s})`}M(),console.log("Mureinoki \xB7 2025")});})();
