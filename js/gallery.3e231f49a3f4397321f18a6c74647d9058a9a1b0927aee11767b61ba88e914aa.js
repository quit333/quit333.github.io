(()=>{window.addEventListener("load",async()=>{let i=document.querySelector("article"),c=document.getElementsByClassName("gallery")[0],C=document.getElementById("top-button"),p=new Set,f=5,h="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",u=0,b="",m=[],d,g=0,M,y,L=document.createElement("div"),s=new Set,T=0,A=0,$="",q=!1;C.appendChild(L);function l(){let n=Array.from(s).slice(0,5),e=s.size>5?` (+${s.size-5} more)`:""}let k=new IntersectionObserver(n=>{n.forEach(e=>{let t=e.target;t.tagName==="IMG"&&(e.isIntersecting?t.dataset.originalSrc&&t.src===h&&(t.src=t.dataset.originalSrc):(!t.style.width&&t.naturalWidth&&(t.style.width=t.offsetWidth+"px",t.style.height=t.offsetHeight+"px"),t.src&&t.src!==h&&(t.src=h))),t.tagName==="VIDEO"&&(e.isIntersecting?t.play().catch(o=>console.warn("Video play error:",o)):t.pause())})},{root:i,rootMargin:"250px 0px 250px 0px"});try{let e=await(await fetch("media.json")).json();b=e.gallery_name,m=e.items,v(),await I()}catch(n){console.error("Failed to load media.json:",n)}function v(){let n=document.createElement("div"),e=document.createElement("div");n.className="grid-sizer",e.className="gutter-sizer",c.appendChild(n),c.appendChild(e),d=new Masonry(c,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function I(){for(;i.scrollHeight<=i.clientHeight+200;)await S()}i.addEventListener("scroll",async()=>{if(y)return;y=setTimeout(()=>y=null,100),i.scrollTop>=i.scrollHeight-i.clientHeight-500&&await S()}),C.addEventListener("click",async()=>{W(m),c.innerHTML="",p.clear(),v(),u=0,await I()});function B(){clearTimeout(M),M=setTimeout(()=>{d.layout()},100)}async function S(){if(u>=Math.ceil(m.length/f)||g>=10)return;let n=u;u++,g++;let e=m.slice(n*f,(n+1)*f);for(let t of e)!t||!t.media||p.has(t.media)||(p.add(t.media),await x(t),await new Promise(o=>requestAnimationFrame(o)));B(),g--}async function x(n){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${b}`,t=n.source.startsWith("http")?n.source:`${e}/${n.source}`,o=n.media.startsWith("http")?n.media:`${e}/${n.media}`;if(T++,$=o,l(),n.type==="image")return await P(t,o);if(n.type==="video")return await G(t,o);if(n.type==="url")return H(t);console.warn("Unknown type:",n.type)}function w(n){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(n),e}function H(n){let e=document.createElement("a");e.id="link-card",e.href=n,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=_();let t=document.createElement("p");t.textContent=n,e.appendChild(t);let o=w(e);c.appendChild(o),d.appended(o),A++,l()}async function P(n,e){return s.add(e),new Promise(t=>{let o=document.createElement("img");o.src=e,o.dataset.originalSrc=e;let a=document.createElement("a");a.href=n,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),imagesLoaded(o,()=>{let r=w(a);c.appendChild(r),d.appended(r),k.observe(o),t(r),A++,s.delete(e),l()}),o.addEventListener("error",()=>{console.warn("Image failed to load:",e),t(null),s.delete(e),l()},{once:!0})})}async function G(n,e){return new Promise(t=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0,o.dataset.originalSrc=e;let a=document.createElement("source");a.src=e,o.appendChild(a);let r=document.createElement("a");r.href=n,r.target="_blank",r.rel="noopener noreferrer",r.appendChild(o);let N=()=>{s.delete(e),l()},j=()=>{let E=w(r);c.appendChild(E),d.appended(E),k.observe(o),t(E),A++,l(),N()},z=()=>{console.warn("Video failed to load:",e),t(null),N()};o.addEventListener("loadeddata",j,{once:!0}),o.addEventListener("error",z,{once:!0}),a.addEventListener("error",z,{once:!0})})}function W(n){for(let e=n.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}}function _(){let n=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),t=Math.floor(Math.random()*100);return`rgb(${n}, ${e}, ${t})`}});console.log("Mureinoki \xB7 2025");})();
