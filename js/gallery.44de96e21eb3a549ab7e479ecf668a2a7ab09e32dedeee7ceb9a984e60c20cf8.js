(()=>{window.addEventListener("load",()=>{let a=document.querySelector("article"),w=document.querySelector(".gallery"),H=document.getElementById("top-button"),E,x=a.clientHeight,M=0,I=[],y=!1,f=null,b=0;class R{constructor(e,o,r=5,n=10,i=15){this.scrollArea=e,this.gallery=o,this.gallery.style.position="relative",this.itemCache=[],this.gaps=n,this.columns=r,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=i,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>e.classList.add("visible"))}restore(e){requestAnimationFrame(()=>e.classList.add("visible"))}virtualize(){if(this.rowIndex<=this.virtRowThreshold)return;let e=this.rowIndex-this.virtRowThreshold,o=Array.from(this.gallery.children).find(n=>parseInt(n.dataset.row)===e&&parseInt(n.dataset.column)===0);if(!o)return;this.rowDeleteTop=o.offsetTop,this.onRowVirtualized(this.rowDeleteTop);let r=this.scrollArea.scrollTop;Array.from(this.gallery.children).forEach(n=>{parseInt(n.dataset.row)<e&&n.offsetTop+n.offsetHeight<this.scrollArea.scrollTop&&(this.itemCache.some(i=>i[0]===n.dataset.jsonIndex)||this.itemCache.push([n.dataset.jsonIndex,n.dataset.row,n.offsetTop,n.offsetLeft,n.offsetWidth,n.offsetHeight]),n.remove())})}}let $=(()=>{let t=null;function e(){return t||(t=fetch("media.json").then(o=>{if(!o.ok)throw new Error("Failed to load media.json");return o.json()})),t}return{load:e}})();class k{constructor(){this.controller=new AbortController,this.signal=this.controller.signal,this.cleanups=new Set}run(e){if(!this.signal.aborted)return e(this.signal,this.onCleanup.bind(this))}onCleanup(e){this.cleanups.add(e)}dispose(){this.controller.abort();for(let e of this.cleanups)try{e()}catch{}this.cleanups.clear()}}let m=null;async function C(t=!1){m?.dispose(),m=new k,m.run((o,r)=>{let n=()=>{let i=a.scrollTop>=a.scrollHeight-a.clientHeight-x,c=b!==0&&a.scrollTop<=b+x;i&&!y?(y=!0,T(m),f.virtualize(),y=!1):c&&m.run((d,h)=>P(f,d,h))};a.addEventListener("scroll",n),r(()=>a.removeEventListener("scroll",n))});let e=await $.load();f=null,w.innerHTML="",M=0,y=!1,b=0,E=e.gallery_name,I=t?F(e.items):e.items,W(m)}function W(t){t.run((e,o)=>{f=new R(a,w,window.innerWidth<=767?2:5,10),o(()=>f.destroy?.()),f.onRowVirtualized=r=>b=r,q(e,o)})}function q(t,e){let o;function r(){t.aborted||(a.scrollHeight<=a.clientHeight+x&&T(m),o=requestAnimationFrame(r))}o=requestAnimationFrame(r),e(()=>cancelAnimationFrame(o))}function T(t){if(!t||t.signal.aborted)return;let o=M++*5,r=I.slice(o,o+5);r.length!==0&&r.forEach((n,i)=>{if(!n)return;let c=o+i;t.run((d,h)=>L(n,c,null,d,h))})}function P(t,e,o){if(e.aborted)return;t.itemCache.splice(-5,5).forEach(([n,i,c,d,h,p])=>{let s=I[n],l=document.createElement("div");l.className="gallery-item loading",l.style.position="absolute",l.style.width=h+"px",l.style.height=p+"px",l.style.left=d+"px",l.style.top=c+"px",l.dataset.jsonIndex=n,l.dataset.row=i,o(()=>l.remove()),L(s,n,l,e,o)})}function L(t,e,o=null,r,n){if(r.aborted)return;let i=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${E}`,c=t.fullres?t.fullres.startsWith("http")?t.fullres:`${i}/${t.fullres}?raw=true`:null,d=t.thumbnail?t.thumbnail.startsWith("http")?t.thumbnail:`${i}/${t.thumbnail}?raw=true`:null,h=t.source||null;return j(t.type,c,d,h,e,o,r,n)}function S(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}function j(t,e,o,r,n,i=null,c,d){return new Promise(h=>{if(c.aborted)return;let p=S(e),s,l;t==="image"?(s=document.createElement("img"),s.src=o||e):t==="video"?(s=document.createElement("video"),l=document.createElement("source"),l.src=o||e,s.appendChild(l),s.autoplay=s.loop=s.muted=s.playsInline=!0):(s=document.createElement("p"),s.textContent=r,p.id="link-card",p.style.backgroundColor=B()),p.appendChild(s);let u=i,A=!1;if(u?(A=!0,w.prepend(u),f.restore(u)):(u=document.createElement("div"),u.className="gallery-item",u.dataset.jsonIndex=n),u.appendChild(p),r&&t!=="url"){let z=S(r),v=document.createElement("div");v.className="gallery-source",v.textContent="\u{1F517}\uFE0F",z.appendChild(v),u.appendChild(z)}d(()=>u.remove());let g=D(h,u,A,c);t==="image"?imagesLoaded(s).on("done",g.success).on("fail",g.error):t==="video"?(s.addEventListener("loadeddata",g.success,{once:!0}),s.addEventListener("error",g.error,{once:!0}),l&&l.addEventListener("error",()=>g.error(),{once:!0})):g.success()})}function D(t,e,o,r){return{success:()=>{if(r.aborted)return t(null);o?e.classList.remove("loading"):(w.appendChild(e),f.append(e)),t(e)},error:()=>{console.error("Media didn't resolve."),t(null)}}}function F(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}function B(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}H.addEventListener("click",()=>C(!0)),C(),console.log("Mureinoki \xB7 2025")});})();
