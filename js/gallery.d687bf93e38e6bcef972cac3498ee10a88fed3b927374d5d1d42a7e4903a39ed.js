(()=>{window.addEventListener("load",()=>{let r=document.querySelector("article"),m=document.getElementById("top-button"),l=document.getElementById("gallery"),c=0,s=[],u,y,p="";h(),fetch("media.json").then(e=>e.json()).then(e=>{p=e.gallery_name,s=e.items,i()});function i(){r.scrollHeight<=r.clientHeight+200&&(f(),setTimeout(i,100))}function h(){let e=window.getComputedStyle(l);u=parseInt(e.rowGap),y=parseInt(e.columnGap)}function f(){s.slice(c*5,(c+1)*5).forEach(n=>{try{E(n)}catch(t){console.warn("Error loading media item:",n,t)}}),c++}function E(e){let n=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${p}`;if(!e||!e.source||!e.type){console.warn("Invalid media item:",e);return}let t=e.source.startsWith("http")?e.source:`${n}/${e.source}`,o=e.media.startsWith("http")?e.media:`${n}/${e.media}`;switch(e.type){case"image":b(t,o);break;case"video":w(t,o);break;case"url":k(t,o);break;default:console.warn("Unknown media type:",e.type)}}function b(e,n){let t=document.createElement("img");t.src=n;let o=document.createElement("a");o.href=e,o.target="_blank",o.rel="noopener noreferrer",o.appendChild(t),t.addEventListener("load",()=>{d(o)})}function w(e,n){let t=document.createElement("video");t.autoplay=!0,t.loop=!0,t.muted=!0,t.dataset.src=n;let o=document.createElement("source");o.src=n,t.appendChild(o);let a=document.createElement("a");a.href=e,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(t),t.addEventListener("loadeddata",()=>{t.closest(".gallery-item")||(d(a),v.observe(t))})}function k(e,n){let t=document.createElement("a");t.id="link-card",t.href=e,t.target="_blank",t.rel="noopener noreferrer",t.style.backgroundColor=C();let o=document.createElement("p");o.textContent=e,t.appendChild(o),d(t)}function d(e){if(!e)return;let n=document.createElement("div");n.className="gallery-item",n.appendChild(e),l.appendChild(n),g(n)}function g(e){if(e.dataset.rowSpanLocked)return;let n=e.querySelector("img, video, iframe");if(!n||n.tagName==="VIDEO"&&n.readyState<3)return;let t=n.clientHeight||n.offsetHeight||100,o=Math.ceil(t/u);e.style.gridRowEnd=`span ${o}`,e.dataset.rowSpanLocked="true"}let v=new IntersectionObserver(e=>{e.forEach(n=>{let t=n.target;if(t.tagName==="VIDEO")if(n.isIntersecting){if(!t.querySelector("source")){let o=document.createElement("source");o.src=t.dataset.src,t.appendChild(o),t.load()}t.play()}else{t.pause();let o=t.querySelector("source");o&&(o.remove(),t.load())}})},{root:r,rootMargin:"250px 0px 250px 0px"});m.addEventListener("click",()=>{M(s),l.innerHTML="",c=0,i()});function M(e){for(let n=e.length-1;n>0;n--){let t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}function C(){let e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100),t=Math.floor(Math.random()*100);return`rgb(${e}, ${n}, ${t})`}r.addEventListener("scroll",()=>{r.scrollTop>=r.scrollHeight-r.clientHeight-500&&f()}),window.addEventListener("resize",()=>{h(),document.querySelectorAll(".gallery-item").forEach(g)})});})();
