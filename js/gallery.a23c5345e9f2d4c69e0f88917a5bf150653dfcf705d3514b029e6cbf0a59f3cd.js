(()=>{window.addEventListener("load",()=>{let r=document.querySelector("article"),g=document.getElementById("top-button"),l=document.getElementById("gallery"),c=0,s=[],u,y,p="";h(),fetch("media.json").then(t=>t.json()).then(t=>{p=t.gallery_name,s=t.items,i()});function i(){r.scrollHeight<=r.clientHeight+200&&(f(),setTimeout(i,100))}function h(){let t=window.getComputedStyle(l);u=parseInt(t.rowGap),y=parseInt(t.columnGap)}function f(){s.slice(c*5,(c+1)*5).forEach(n=>{try{E(n)}catch(e){console.warn("Error loading media item:",n,e)}}),c++}function E(t){let n=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${p}`;if(!t||!t.source||!t.type){console.warn("Invalid media item:",t);return}let e=t.source.startsWith("http")?t.source:`${n}/${t.source}`,o=t.media.startsWith("http")?t.media:`${n}/${t.media}`;switch(t.type){case"image":w(e,o);break;case"video":b(e,o);break;case"url":k(e,o);break;default:console.warn("Unknown media type:",t.type)}}function w(t,n){let e=document.createElement("img");e.src=n;let o=document.createElement("a");o.href=t,o.target="_blank",o.rel="noopener noreferrer",o.appendChild(e),e.addEventListener("load",()=>{d(o),e.dataset.rowSpanLocked="true"})}function b(t,n){let e=document.createElement("video");e.autoplay=!0,e.loop=!0,e.muted=!0,e.dataset.src=n;let o=document.createElement("source");o.src=n,e.appendChild(o);let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(e),e.addEventListener("loadeddata",()=>{e.closest(".gallery-item")||(d(a),v.observe(e),e.dataset.rowSpanLocked="true")})}function k(t,n){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=C();let o=document.createElement("p");o.textContent=t,e.appendChild(o),d(e)}function d(t){if(!t)return;let n=document.createElement("div");n.className="gallery-item",n.appendChild(t),l.appendChild(n),m(n)}function m(t){let n=t.querySelector("img, video, iframe");if(!n||n.dataset.rowSpanLocked)return;let e=n.clientHeight,o=Math.ceil(e/u);t.style.gridRowEnd=`span ${o}`}let v=new IntersectionObserver(t=>{t.forEach(n=>{let e=n.target;if(e.tagName==="VIDEO")if(n.isIntersecting){if(!e.querySelector("source")){let o=document.createElement("source");o.src=e.dataset.src,e.appendChild(o),e.load()}e.play()}else{e.pause();let o=e.querySelector("source");o&&(o.remove(),e.load())}})},{root:r,rootMargin:"250px 0px 250px 0px"});g.addEventListener("click",()=>{M(s),l.innerHTML="",c=0,i()});function M(t){for(let n=t.length-1;n>0;n--){let e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}}function C(){let t=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100);return`rgb(${t}, ${n}, ${e})`}r.addEventListener("scroll",()=>{r.scrollTop>=r.scrollHeight-r.clientHeight-500&&f()}),window.addEventListener("resize",()=>{h(),document.querySelectorAll(".gallery-item").forEach(m)})});})();
