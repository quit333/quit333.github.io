(()=>{window.addEventListener("load",()=>{let a=document.querySelector("article"),g=document.querySelector(".gallery"),S=document.getElementById("top-button"),v,x=a.clientHeight,E=0,I=[],y=!1,f=null,b=0;class A{constructor(e,o,r=5,n=10,i=15){this.scrollArea=e,this.gallery=o,this.gallery.style.position="relative",this.itemCache=[],this.gaps=n,this.columns=r,this.columnIndex=0,this.columnWidth=(this.gallery.clientWidth-this.gaps*(this.columns-1))/this.columns,this.rowIndex=0,this.rowMax=0,this.rowPositions=new Array(this.columns).fill(0),this.virtRowThreshold=i,this.onRowVirtualized=()=>{}}append(e){this.columnIndex=this.columnIndex%this.columns,e.style.position="absolute",e.style.left=`${this.columnIndex*(this.columnWidth+this.gaps)}px`,e.style.top=`${this.rowPositions[this.columnIndex]}px`,e.dataset.row=this.rowIndex,e.dataset.column=this.columnIndex,e.title=`column: ${this.columnIndex} | row: ${this.rowIndex}`,this.rowPositions[this.columnIndex]+=e.offsetHeight+this.gaps,this.rowPositions[this.columnIndex]>this.rowMax?this.columnIndex++:this.columnIndex===0&&this.rowIndex++,this.columnIndex>=this.columns&&(this.rowMax=Math.max(...this.rowPositions),this.rowIndex++),requestAnimationFrame(()=>e.classList.add("visible"))}restore(e){requestAnimationFrame(()=>e.classList.add("visible"))}virtualize(){if(this.rowIndex<=this.virtRowThreshold)return;let e=this.rowIndex-this.virtRowThreshold,o=Array.from(this.gallery.children).find(n=>parseInt(n.dataset.row)===e&&parseInt(n.dataset.column)===0);if(!o)return;this.rowDeleteTop=o.offsetTop,this.onRowVirtualized(this.rowDeleteTop);let r=this.scrollArea.scrollTop;Array.from(this.gallery.children).forEach(n=>{parseInt(n.dataset.row)<e&&n.offsetTop+n.offsetHeight<this.scrollArea.scrollTop&&(this.itemCache.some(i=>i[0]===n.dataset.jsonIndex)||this.itemCache.push([n.dataset.jsonIndex,n.dataset.row,n.offsetTop,n.offsetLeft,n.offsetWidth,n.offsetHeight]),n.remove())})}}let $=(()=>{let t=null;function e(){return t||(t=fetch("media.json").then(o=>{if(!o.ok)throw new Error("Failed to load media.json");return o.json()})),t}return{load:e}})();class z{constructor(){this.controller=new AbortController,this.signal=this.controller.signal,this.cleanups=new Set}run(e){if(!this.signal.aborted)return e(this.signal,this.onCleanup.bind(this))}onCleanup(e){this.cleanups.add(e)}dispose(){this.controller.abort();for(let e of this.cleanups)try{e()}catch{}this.cleanups.clear()}}let m=null;async function M(t=!1){m?.dispose(),m=new z,m.run((o,r)=>{let n=()=>{let i=a.scrollTop>=a.scrollHeight-a.clientHeight-x,c=b!==0&&a.scrollTop<=b+x;i&&!y?(y=!0,T(m),f.virtualize(),y=!1):c&&m.run((h,u)=>k(f,h,u))};a.addEventListener("scroll",n),r(()=>a.removeEventListener("scroll",n))});let e=await $.load();f=null,g.innerHTML="",E=0,y=!1,b=0,v=e.gallery_name,I=t?j(e.items):e.items,H(m)}function H(t){t.run((e,o)=>{f=new A(a,g,window.innerWidth<=767?2:5,10),o(()=>f.destroy?.()),f.onRowVirtualized=r=>b=r,R(e,o)})}function R(t,e){let o;function r(){t.aborted||(a.scrollHeight<=a.clientHeight+x&&T(m),o=requestAnimationFrame(r))}o=requestAnimationFrame(r),e(()=>cancelAnimationFrame(o))}function T(t){if(!t||t.signal.aborted)return;let o=E++*5,r=I.slice(o,o+5);r.length!==0&&r.forEach((n,i)=>{if(!n?.preview)return;let c=o+i;t.run((h,u)=>L(n,c,null,h,u))})}function k(t,e,o){if(e.aborted)return;t.itemCache.splice(-5,5).forEach(([n,i,c,h,u,p])=>{let s=I[n],l=document.createElement("div");l.className="gallery-item loading",l.style.position="absolute",l.style.width=u+"px",l.style.height=p+"px",l.style.left=h+"px",l.style.top=c+"px",l.dataset.jsonIndex=n,l.dataset.row=i,o(()=>l.remove()),L(s,n,l,e,o)})}function L(t,e,o=null,r,n){if(r.aborted)return;let i=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${v}`,c=t.fullres?t.fullres.startsWith("http")?t.fullres:`${i}/${t.fullres}?raw=true`:null,h=t.thumbnail?t.thumbnail.startsWith("http")?t.thumbnail:`${i}/${t.thumbnail}?raw=true`:null,u=t.source||null;return P(t.type,c,h,u,e,o,r,n)}function q(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e}function P(t,e,o,r,n,i=null,c,h){return new Promise(u=>{if(c.aborted)return;let p=q(e),s,l;t==="image"?(s=document.createElement("img"),s.src=o||e):t==="video"?(s=document.createElement("video"),l=document.createElement("source"),l.src=o||e,s.appendChild(l),s.autoplay=s.loop=s.muted=s.playsInline=!0):(s=document.createElement("p"),s.textContent=r,p.id="link-card",p.style.backgroundColor=D()),p.appendChild(s);let d=i,C=!1;d?(C=!0,g.prepend(d),f.restore(d)):(d=document.createElement("div"),d.className="gallery-item",d.dataset.jsonIndex=n),d.appendChild(p),h(()=>d.remove());let w=W(u,d,C,c);t==="image"?imagesLoaded(s).on("done",w.success).on("fail",w.error):t==="video"?(s.addEventListener("loadeddata",w.success,{once:!0}),s.addEventListener("error",w.error,{once:!0}),l&&l.addEventListener("error",()=>w.error(),{once:!0})):w.success()})}function W(t,e,o,r){return{success:()=>{if(r.aborted)return t(null);o?e.classList.remove("loading"):(g.appendChild(e),f.append(e)),t(e)},error:()=>{console.error("Media didn't resolve."),t(null)}}}function j(t){for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}function D(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),o=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${o})`}S.addEventListener("click",()=>M(!0)),M(),console.log("Mureinoki \xB7 2025")});})();
