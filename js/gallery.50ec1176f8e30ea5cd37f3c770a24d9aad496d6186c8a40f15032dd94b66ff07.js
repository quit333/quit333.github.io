(()=>{window.addEventListener("load",()=>{class g{constructor({scrollArea:t,galleryCss:e="gallery",minItemWidth:s=250,gap:r=10}){this.scrollArea=t,this.gallery=document.createElement("div"),this.galleryUI=document.createElement("div"),this.galleryCss=e,this.minItemWidth=s,this.columns=0,this.gap=r,this.tags=[],this.colHeights=[],this.positions=[],this.visible=new Map,this.abortController=new AbortController,this.mediaQueue=[],this.readyQueue=[],this.scrollBuffer=this.scrollArea.clientHeight*2,this.commitScheduled=!1,this.maxUrlItemPerBatch=2,this.batchSize=4,this.onTag=this.onTag.bind(this),this.onShuffle=this.onShuffle.bind(this),this.onScroll=this.onScroll.bind(this)}async init(){this.reset(),await this.fetchData(),this.createGalleryUI(),this.initColumns(),this.fillInitialViewport()}reset(){this.destroy(),this.abortController=new AbortController,this.scrollArea.appendChild(this.gallery),this.gallery.className=this.galleryCss,this.gallery.style.position="relative",this.gallery.style.height="0px",this.scrollArea.focus(),this.scrollArea.addEventListener("scroll",this.onScroll)}destroy(){this.abortController.abort(),this.scrollArea.removeEventListener("scroll",this.onScroll),this.clear(),this.readyQueue=[]}clear(){this.gallery.innerHTML="",this.gallery.remove(),this.galleryUI.innerHTML="",this.galleryUI.remove(),this.positions=[],this.visible.clear(),this.colHeights=new Array(this.columns).fill(0),this.gallery.style.height="0px"}async fetchData(){let e=await(await fetch("media.json",{signal:this.abortController.signal})).json();this.galleryName=e.gallery_name,this.tags=e.library_tags,this.mediaQueue=e.items.slice()}initColumns(){this.currentColumns=this.getColumnCount(),this.colHeights=new Array(this.currentColumns).fill(0),this.columnWidth=(this.scrollArea.clientWidth-this.gap*(this.currentColumns-1))/this.currentColumns}getColumnCount(){return this.columns=Math.ceil(this.scrollArea.clientWidth/this.minItemWidth),Math.max(2,this.columns)}async fillInitialViewport(){for(;this.scrollArea.scrollHeight<this.scrollArea.clientHeight+this.scrollBuffer&&this.mediaQueue.length;)await this.loadNext()}fillWhileNeeded(t){Math.min(...this.colHeights)<t+this.scrollBuffer&&this.mediaQueue.length&&this.loadNext()}virtualize(t,e){for(let[s,r]of this.visible.entries()){let i=this.positions[s];(i.top+i.height<t-this.scrollBuffer||i.top>e+this.scrollBuffer)&&(r.remove(),this.visible.delete(s))}this.positions.forEach((s,r)=>{if(!this.visible.has(r)&&s.top+s.height>=t-this.scrollBuffer&&s.top<=e+this.scrollBuffer){let i=s.el;this.gallery.appendChild(i),this.visible.set(r,i)}})}async loadNext(){if(!this.mediaQueue.length)return;let t=this.mediaQueue.shift(),e=this.abortController.signal;try{let s=await this.createItem(t);if(s.__media=t,e.aborted)return;this.readyQueue.push({el:s,media:t}),this.scheduleCommit()}catch{}}scheduleCommit(){this.commitScheduled||(this.commitScheduled=!0,requestAnimationFrame(()=>this.commitBatch()))}commitBatch(){if(this.commitScheduled=!1,!this.readyQueue.length)return;let t=0,e=0;for(let s=0;s<this.readyQueue.length&&t<this.batchSize;s++){let r=this.readyQueue[s];r.media.type==="text"&&e>=this.maxUrlItemPerBatch||(this.readyQueue.splice(s,1),s--,this.placeItem(r.el),t++,r.media.type==="text"&&e++)}this.readyQueue.length&&this.scheduleCommit()}placeItem(t){let e=this.colHeights.indexOf(Math.min(...this.colHeights)),s=this.colHeights[e],r=e*(this.columnWidth+this.gap);t.style.position="absolute",t.style.width=`${this.columnWidth}px`,t.style.top=`${s}px`,t.style.left=`${r}px`,this.gallery.appendChild(t),t.classList.add("visible");let i=t.offsetHeight,l=this.positions.length;this.positions.push({top:s,height:i,el:t}),this.colHeights[e]+=i+this.gap,this.gallery.style.height=`${Math.max(...this.colHeights)}px`,this.visible.set(l,t)}createWrapper(t){let e=document.createElement("a");return e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.tabIndex=-1,e}async createItem(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${this.galleryName}`,s=t.fullres?t.fullres.startsWith("http")?t.fullres:`${e}/${t.fullres}`:null,r=t.thumbnail?t.thumbnail.startsWith("http")?t.thumbnail:`${e}/${t.thumbnail}`:null,i=t.source&&t.source.startsWith("http")?t.source:null,l;if(t.type==="url"){l=document.createElement("div"),l.className="gallery-item",l.style.background=`hsl(${Math.random()*360},30%,30%)`,l.style.padding="0px",l.style.width=`${this.columnWidth}px`;let a=document.createElement("p");a.textContent=i||"",l.appendChild(a)}else t.type==="video"?(l=document.createElement("video"),l.className="gallery-item",l.controls=!1,l.src=s,l.autoplay=l.loop=l.muted=l.playsInline=!0,await n(l)):(l=document.createElement("img"),l.className="gallery-item",l.src=r||s,await n(l));let h=this.createWrapper(s);if(h.className="gallery-item-wrapper",h.appendChild(l),i&&t.type!=="url"){let a=this.createWrapper(i);a.className="gallery-source",h.appendChild(a)}return h}createGalleryUI(){this.tagBar=document.createElement("div"),this.tagButton=document.createElement("div"),this.shuffleButton=document.createElement("div"),this.tagButton.addEventListener("click",this.onTag),this.shuffleButton.addEventListener("click",this.onShuffle);let t=this.scrollArea.parentElement,e=this.gallery.clientWidth;this.galleryUI.style.position="relative",this.galleryUI.style.margin="0px",this.galleryUI.style.userSelect="none",t.prepend(this.galleryUI),this.tagBar.style.position="absolute",this.tagBar.style.display="none",this.tagBar.style.top="0px",this.tagBar.style.left="0px",this.tagBar.style.backgroundColor="rgba(0, 0, 0, 0.4)",this.tagBar.style.zIndex="100",this.tagBar.style.width=`${e}px`,this.tagBar.style.marginLeft="40px",this.tagBar.style.marginRight="40px";let s=document.createElement("div");if(s.style.display="flex",s.style.overflowY="auto",this.tagBar.appendChild(s),this.tags.length>0){let i=document.createDocumentFragment();this.tags.forEach((l,h)=>{let a=document.createElement("div");a.textContent=l,a.style.backgroundColor="#242424",a.style.borderRadius="4px",h===0?a.style.margin="4px 4px 4px auto":h===this.tags.length-1?a.style.margin="4px auto 4px 4px":a.style.margin="4px",a.style.padding="4px",a.style.cursor="pointer",i.appendChild(a)}),s.appendChild(i)}else s.textContent="No tags were found...",s.style.justifyContent="center";let r=document.createElement("hr");if(this.tagBar.appendChild(r),this.galleryUI.prepend(this.tagBar),this.tagButton.style.cursor="pointer",this.tagButton.style.position="absolute",this.tagButton.style.top="0px",this.tagButton.style.right="0px",this.tagButton.style.margin="0px",this.tagButton.style.right=`${this.gap}px`,this.tagButton.textContent="\u25C0\uFE0F",this.galleryUI.appendChild(this.tagButton),this.shuffleButton.style.cursor="pointer",this.shuffleButton.style.position="absolute",this.shuffleButton.style.top="20px",this.shuffleButton.style.right="0px",this.shuffleButton.style.margin="0px",this.shuffleButton.style.right=`${this.gap}px`,this.shuffleButton.textContent="\u{1F500}\uFE0F",this.galleryUI.appendChild(this.shuffleButton),this.galleryName.includes("resources")){let i=document.createElement("div");i.style.cursor="pointer",i.style.position="absolute",i.style.top="40px",i.style.right="0px",i.style.margin="0px",i.style.right=`${this.gap}px`,i.textContent="\u{1F519}\uFE0F",i.addEventListener("click",()=>{history.back()}),this.galleryUI.appendChild(i)}}onTag(){this.tagBar.style.display==="none"?this.tagBar.style.display="block":this.tagBar.style.display="none"}async onShuffle(){this.abortController.abort(),this.abortController=new AbortController;let t=[...this.mediaQueue,...this.readyQueue.map(e=>e.media),...this.positions.map(e=>e.el?.__media).filter(Boolean)];this.shuffle(t),this.mediaQueue=t,this.reset(),this.initColumns(),this.createGalleryUI(),this.scrollArea.focus(),await this.fillInitialViewport()}shuffle(t){for(let e=t.length-1;e>0;e--){let s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}}onScroll(){let t=this.scrollArea.scrollTop,e=t+this.scrollArea.clientHeight;this.virtualize(t,e),this.fillWhileNeeded(e)}}function n(o){return new Promise((t,e)=>{o.tagName==="IMG"?(o.onload=t,o.onerror=e):o.tagName==="VIDEO"?(o.onloadedmetadata=t,o.onerror=e):t()})}let c=document.querySelector("article");c.innerHTML="";function u(){gallery=new g({scrollArea:c}),gallery.init()}let d=window.innerWidth;window.addEventListener("resize",function(){let o=window.innerWidth;o!==d&&(d=o,gallery.destroy(),u())}),u()});})();
