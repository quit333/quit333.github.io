(()=>{window.addEventListener("load",()=>{let r=document.querySelector("article"),E=document.getElementById("top-button"),i=document.getElementById("gallery"),l=0,s=[],p=0,v=0,f="";g(),fetch("media.json").then(e=>e.json()).then(e=>{f=e.gallery_name,s=e.items,d()}).catch(e=>{console.error("Failed to load media.json:",e)});let c=!1;function d(){c||r.scrollHeight<=r.clientHeight+200&&(c=!0,m(),setTimeout(()=>{d()},200))}function g(){let e=window.getComputedStyle(i);p=parseInt(e.rowGap),v=parseInt(e.columnGap)}function m(){s.slice(l*5,(l+1)*5).forEach(n=>{try{w(n)}catch(t){console.warn("Error loading media item:",n,t)}}),c=!1,l++}let u=new Set;function w(e){let n=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${f}`;if(!e||!e.source||!e.type){console.warn("Invalid media item:",e);return}let t=e.source.startsWith("http")?e.source:`${n}/${e.source}`,o=e.media.startsWith("http")?e.media:`${n}/${e.media}`;if(!u.has(o))switch(u.add(o),e.type){case"image":b(t,o);break;case"video":k(t,o);break;case"url":M(t,o);break;default:console.warn("Unknown media type:",e.type)}}function b(e,n){let t=document.createElement("img");t.src=n;let o=document.createElement("a");o.href=e,o.target="_blank",o.rel="noopener noreferrer",o.appendChild(t),t.addEventListener("load",()=>{h(o)}),t.addEventListener("error",()=>{console.warn("Image failed to load:",n),o.remove()})}function k(e,n){let t=document.createElement("video");t.autoplay=!0,t.loop=!0,t.muted=!0;let o=document.createElement("source");o.src=n,t.appendChild(o);let a=document.createElement("a");a.href=e,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(t),t.addEventListener("loadeddata",()=>{t.closest(".gallery-item")||(h(a),C.observe(t))}),t.addEventListener("error",()=>{console.warn("Video failed to load:",n),a.remove()})}function M(e,n){let t=document.createElement("a");t.id="link-card",t.href=e,t.target="_blank",t.rel="noopener noreferrer",t.style.backgroundColor=S();let o=document.createElement("p");o.textContent=e,t.appendChild(o),h(t)}function h(e){if(!e)return;let n=document.createElement("div");n.className="gallery-item",n.appendChild(e),i.appendChild(n),y(n)}function y(e){let n=e.querySelector("img, video, iframe");if(!n)return;let t=n.clientHeight,o=Math.ceil(t/p);e.style.gridRowEnd=`span ${o}`}let C=new IntersectionObserver(e=>{e.forEach(n=>{let t=n.target;t.tagName==="VIDEO"&&(n.isIntersecting?t.play().catch(o=>console.warn("Video play error:",o)):t.pause())})},{root:r,rootMargin:"250px 0px 250px 0px"});E.addEventListener("click",()=>{L(s),i.innerHTML="",l=0,u.clear(),d()});function L(e){for(let n=e.length-1;n>0;n--){let t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}function S(){let e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100),t=Math.floor(Math.random()*100);return`rgb(${e}, ${n}, ${t})`}r.addEventListener("scroll",()=>{c||r.scrollTop>=r.scrollHeight-r.clientHeight-500&&(c=!0,m())}),window.addEventListener("resize",()=>{g(),document.querySelectorAll(".gallery-item").forEach(y)})});})();
