(()=>{window.addEventListener("load",async()=>{let r=document.querySelector("article"),i=document.getElementsByClassName("gallery")[0],E=document.getElementById("top-button"),g=new Set,h=5,s=0,b="",m=[],d,f=0,C=document.createElement("div"),l=new Set,$=0,p=0,M="",T=!1;E.appendChild(C);function u(){let t=Array.from(l).slice(0,5),e=l.size>5?` (+${l.size-5} more)`:"";C.innerHTML=`
			Items Loaded: ${$}<br>
			Items Appended: ${p}<br>
			Page: ${s}/${m.length/5}<br>
			Last Item: ${M}<br>
			ScrollFill: ${r.scrollHeight}<=?${r.clientHeight+200}<br>
			ScrollAdd: ${r.scrollTop}>=?${r.scrollHeight-r.clientHeight-500}<br>
			Pending (${l.size}): ${t.join("<br>")}${e} `}try{let e=await(await fetch("media.json")).json();b=e.gallery_name,m=e.items,k(),await v()}catch(t){console.error("Failed to load media.json:",t)}function k(){let t=document.createElement("div"),e=document.createElement("div");t.className="grid-sizer",e.className="gutter-sizer",i.appendChild(t),i.appendChild(e),d=new Masonry(i,{itemSelector:".gallery-item",columnWidth:".grid-sizer",gutter:".gutter-sizer",percentPosition:!0})}async function v(){for(;r.scrollHeight<=r.clientHeight+200;)await I()}r.addEventListener("scroll",async()=>{r.scrollTop>=r.scrollHeight-r.clientHeight-500&&await I()}),E.addEventListener("click",async()=>{j(m),i.innerHTML="",g.clear(),k(),s=0,await v()});async function I(){if(s>=Math.ceil(m.length/h)||s-f>=5)return;let t=s;s++;let e=m.slice(t*h,(t+1)*h);for(let n of e)!n||!n.media||g.has(n.media)||(g.add(n.media),await z(n));t===f&&f++}async function z(t){let e=`https://raw.githubusercontent.com/quit333/quit3-backup/refs/heads/master/${b}`,n=t.source.startsWith("http")?t.source:`${e}/${t.source}`,o=t.media.startsWith("http")?t.media:`${e}/${t.media}`;if($++,M=o,u(),t.type==="image")return await N(n,o);if(t.type==="video")return await P(n,o);if(t.type==="url")return H(n);console.warn("Unknown type:",t.type)}function y(t){let e=document.createElement("div");return e.className="gallery-item",e.appendChild(t),e}function H(t){let e=document.createElement("a");e.id="link-card",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.style.backgroundColor=x();let n=document.createElement("p");n.textContent=t,e.appendChild(n);let o=y(e);i.appendChild(o),d.appended(o),d.layout(),p++,u()}async function N(t,e){return l.add(e),new Promise(n=>{let o=document.createElement("img");o.src=e;let a=document.createElement("a");a.href=t,a.target="_blank",a.rel="noopener noreferrer",a.appendChild(o),imagesLoaded(o,()=>{let c=y(a);i.appendChild(c),d.appended(c),d.layout(),n(c),p++,l.delete(e),u()}),o.addEventListener("error",()=>{console.warn("Image failed to load:",e),n(null),l.delete(e),u()},{once:!0})})}async function P(t,e){return new Promise(n=>{let o=document.createElement("video");o.autoplay=!0,o.loop=!0,o.muted=!0;let a=document.createElement("source");a.src=e,o.appendChild(a);let c=document.createElement("a");c.href=t,c.target="_blank",c.rel="noopener noreferrer",c.appendChild(o);let L=()=>{l.delete(e),u()},B=()=>{let w=y(c);i.appendChild(w),d.appended(w),d.layout(),n(w),p++,u(),L()},S=()=>{console.warn("Video failed to load:",e),n(null),L()};o.addEventListener("loadeddata",B,{once:!0}),o.addEventListener("error",S,{once:!0}),a.addEventListener("error",S,{once:!0})})}let V=new IntersectionObserver(t=>{t.forEach(e=>{let n=e.target;n.tagName==="VIDEO"&&(e.isIntersecting?n.play().catch(o=>console.warn("Video play error:",o)):n.pause())})},{root:r,rootMargin:"250px 0px 250px 0px"});function j(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function x(){let t=Math.floor(Math.random()*100),e=Math.floor(Math.random()*100),n=Math.floor(Math.random()*100);return`rgb(${t}, ${e}, ${n})`}});console.log("Mureinoki \xB7 2025");})();
